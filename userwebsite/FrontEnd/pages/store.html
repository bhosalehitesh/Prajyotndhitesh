<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="store-page-title">Store | V Store</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color, #f5f5f5);
      color: var(--text-color, #333);
      transition: background-color 0.3s, color 0.3s;
    }
    
    main {
      background: var(--bg-color);
    }
    
    .container {
      background: transparent;
    }
    
    .page-header {
      padding: 40px 0 20px;
      text-align: center;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-color, #333);
      transition: color 0.3s;
    }
    
    .page-header p {
      font-size: 1.1rem;
      color: var(--text-color, #666);
      opacity: 0.8;
    }
    
    .page-header a {
      display: inline-block;
      color: #ff6d2e;
      text-decoration: none;
      font-size: 0.95rem;
      margin-top: 8px;
      transition: color 0.3s;
    }
    
    .page-header a:hover {
      color: #e55a1f;
      text-decoration: underline;
    }
    
    .page-header img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 0 auto 16px;
      border: 3px solid var(--muted-white, #f5f5f5);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2rem;
      }
      .page-header p {
        font-size: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .page-header {
        padding: 30px 0 15px;
      }
      .page-header h1 {
        font-size: 1.75rem;
      }
    }
    
    /* Load More Button Container */
    .load-more-container {
      grid-column: 1/-1;
      text-align: center;
      padding: 40px 20px;
      margin-top: 20px;
    }
    
    #load-more-products {
      padding: 16px 48px;
      background: linear-gradient(135deg, #ff6d2e 0%, #ff8533 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(255, 109, 46, 0.3);
      letter-spacing: 0.02em;
      font-family: 'Inter', sans-serif;
    }
    
    #load-more-products:hover {
      background: linear-gradient(135deg, #e55a1f 0%, #ff6d2e 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 109, 46, 0.4);
    }
    
    #load-more-products:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(255, 109, 46, 0.3);
    }
    
    #load-more-products:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 768px) {
      #load-more-products {
        padding: 14px 36px;
        font-size: 0.95rem;
      }
    }
    
    /* Debug section - hide in production, show only in development */
    .debug {
      margin-top: 40px;
      padding: 20px;
      background: var(--card-bg, #fff);
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      display: none;
    }
    
    .debug.visible {
      display: block;
    }
    
    pre {
      background: #111;
      color: #e6e6e6;
      padding: 12px;
      border-radius: 6px;
      overflow: auto;
      max-height: 320px;
      font-size: 0.85rem;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .controls label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
    }
    
    .controls input {
      padding: 6px 8px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    
    .controls button {
      padding: 8px 16px;
      background: #ff6d2e;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .controls button:hover {
      background: #e55a1f;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <header class="topbar">
      <div class="topbar-inner container">
        <div class="left-group">
          <div class="avatar" aria-hidden="true">
            <a href="../" style="text-decoration:none;color:inherit;display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><span>V</span></a>
          </div>
          <div class="divider"></div>
          <nav class="main-nav" aria-label="Main">
            <a href="categories.html" class="nav-item">Categories</a>
            <a href="featured.html" class="nav-item">Featured</a>
            <a href="products.html" class="nav-item">Products</a>
          </nav>
          <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle Menu">☰</button>
        </div>
        <div class="right-group">
          <!-- Dark Mode Toggle Switch -->
          <div class="dark-mode-toggle-container">
            <label class="dark-mode-toggle" for="dark-mode-switch" title="Toggle Dark Mode">
              <input type="checkbox" id="dark-mode-switch" class="toggle-input">
              <span class="toggle-track">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="4"></circle>
                  <line x1="12" y1="1" x2="12" y2="3"></line>
                  <line x1="12" y1="21" x2="12" y2="23"></line>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                  <line x1="1" y1="12" x2="3" y2="12"></line>
                  <line x1="21" y1="12" x2="23" y2="12"></line>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <span class="toggle-indicator"></span>
              </span>
            </label>
          </div>

          <button class="icon-btn" id="searchBtn" title="Search Products">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="6" stroke-width="1.6"></circle>
              <path d="M21 21l-4.35-4.35" stroke-width="1.6" stroke-linecap="round"></path>
            </svg>
          </button>

          <button class="icon-btn" id="wishlistBtn" title="Wishlist" onclick="window.location.href='wishlist.html'">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke-width="1.5" stroke-linejoin="round"></path>
            </svg>
            <span class="wishlist-count" id="wishlistCount">0</span>
          </button>
          <button class="icon-btn" id="cartBtn" title="Cart" onclick="window.location.href='cart.html'">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
              <path d="M6 6h15l-1.5 9h-12z" stroke-width="1.5" stroke-linejoin="round"></path>
              <circle cx="10" cy="20" r="1.4" stroke-width="1.5"></circle>
              <circle cx="18" cy="20" r="1.4" stroke-width="1.5"></circle>
            </svg>
            <span class="cart-count" id="cartCount">0</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Profile Sidebar Menu -->
    <div class="profile-sidebar-overlay" id="profileSidebarOverlay"></div>
    <div class="profile-sidebar" id="profileSidebar">
      <div class="profile-sidebar-header">
        <button class="profile-sidebar-close" id="profileSidebarClose" aria-label="Close Menu">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="profile-sidebar-content">
        <div class="profile-sidebar-user">
          <div class="profile-sidebar-avatar">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="profile-sidebar-info">
            <div class="profile-sidebar-name">Hello User</div>
            <div class="profile-sidebar-phone">+1234567890</div>
          </div>
        </div>
        <div class="profile-sidebar-menu">
          <a href="orders.html" class="profile-sidebar-item" id="sidebarMyOrders">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span>My Orders</span>
          </a>
          <a href="wishlist.html" class="profile-sidebar-item" id="sidebarWishlist">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span>My Wishlist</span>
          </a>
          <a href="cart.html" class="profile-sidebar-item" id="sidebarCart">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span>Shopping Cart</span>
          </a>
          <a href="order-tracking.html" class="profile-sidebar-item" id="sidebarTrackOrder">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span>Track Order</span>
          </a>
          <div class="profile-sidebar-divider"></div>
          <div class="profile-sidebar-item" id="sidebarLightMode">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
              <circle cx="8" cy="12" r="3"></circle>
            </svg>
            <span id="sidebarLightModeText">Light Mode</span>
          </div>
          <a href="faq.html" class="profile-sidebar-item" id="sidebarFAQ">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span>Help & FAQ</span>
          </a>
          <div class="profile-sidebar-item" id="sidebarSignOut" onclick="handleSignOut()" style="cursor: pointer;">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Sign Out</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div class="search-modal-content" style="background: var(--card-bg, #fff); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); position: relative;">
        <h3 style="margin-bottom: 20px; color: var(--text-color, #333); font-size: 1.5rem;">Search Products</h3>
        <div style="position: relative; margin-bottom: 20px;">
          <input type="text" class="search-input" id="searchInput" placeholder="Search for products..." autocomplete="off" style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 1rem; background: var(--bg-color, #fff); color: var(--text-color, #333); transition: border-color 0.3s;">
          <button class="search-close" id="searchClose" style="position: absolute; top: 50%; right: 12px; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color, #666); padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div class="search-results" id="searchResults" style="max-height: 400px; overflow-y: auto;">
          <!-- Search results will appear here -->
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" id="mobileNav">
      <a href="categories.html" class="nav-item">Categories</a>
      <a href="featured.html" class="nav-item">Featured</a>
      <a href="products.html" class="nav-item">Products</a>
      <a href="cart.html" class="nav-item">Cart</a>
      <a href="login.html" class="nav-item">Login</a>
    </nav>

    <!-- Login/Signup Modal (Required for store page) -->
    <div class="login-modal-overlay" id="loginModalOverlay">
      <div class="login-modal" id="loginModal">
        <!-- Close Button -->
        <button class="login-modal-close" id="loginModalClose" aria-label="Close">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>

        <!-- Phone Number Login Form -->
        <div class="login-form-container" id="loginFormContainer">
          <h2 class="login-title">Welcome Back</h2>
          <p class="login-subtitle">Login or create an account</p>
          <form class="login-form" id="loginPhoneForm">
            <div class="form-group">
              <label for="loginName">Full Name</label>
              <input type="text" id="loginName" placeholder="Enter your full name" required minlength="2" maxlength="100" autocomplete="name">
            </div>
            <div class="form-group">
              <label for="loginPhone">Phone Number</label>
              <input type="tel" id="loginPhone" placeholder="Enter 10-digit phone number" required pattern="[0-9]{10}" maxlength="10" autocomplete="tel">
            </div>
            <button type="submit" class="login-submit-btn">Get OTP</button>
          </form>
        </div>

        <!-- OTP Verification Form -->
        <div class="login-form-container" id="otpFormContainer" style="display: none;">
          <h2 class="login-title">Verify OTP</h2>
          <p class="login-subtitle" id="otpPhoneDisplay">We have sent a code by SMS to your phone.</p>
          <form class="login-form" id="otpForm">
            <div class="form-group">
              <label for="otpInput">Enter OTP</label>
              <input type="text" id="otpInput" placeholder="Enter OTP" required pattern="[0-9]{6}" maxlength="6" style="text-align: center; font-size: 1.2rem; letter-spacing: 8px; font-weight: 600;">
            </div>
            <button type="submit" class="login-submit-btn" style="background: linear-gradient(135deg, #ff6d2e 0%, #ff8533 100%); margin-bottom: 12px;">Verify and Continue</button>
            <button type="button" class="login-back-btn" id="resendOtpBtn" style="border-color: #ff6d2e; color: #ff6d2e;">Resend OTP</button>
          </form>
        </div>
      </div>
    </div>

    <main id="store-page" style="flex: 1; background: var(--bg-color);">
      <div class="container" style="background: transparent;">
        <!-- Login Required Message (shown when not logged in) -->
        <div id="login-required-message" style="display: none; text-align: center; padding: 60px 20px;">
          <h2 style="font-size: 1.8rem; margin-bottom: 16px; color: var(--text-color, #333);">Login Required</h2>
          <p style="font-size: 1.1rem; color: var(--text-color, #666); margin-bottom: 24px;">Please login to view this store</p>
        </div>
        
        <!-- Store Content (hidden until logged in) -->
        <div id="store-content" style="display: none;">
          <div class="page-header">
            <img id="store-logo" src="../assets/SmartBiz.png" alt="Store Logo" style="display:none;" />
            <h1 id="store-name">Store</h1>
            <a id="store-link" href="#" target="_blank" style="display:none;"></a>
            <p id="store-description"></p>
          </div>

          <div class="ecommerce-grid" id="store-products-grid" style="padding-bottom: 0;"></div>
        </div>
      </div>
  </main>

  <!-- Footer Component (loaded from components/footer.html) -->
  <div id="footer-placeholder" style="width: 100%; margin-top: auto; flex-shrink: 0;"></div>
  </div>
    
    <!-- Debug Section (hidden by default - add ?debug=true to URL to show) -->
    <section class="debug" id="debug-section">
    <h3>Debug API</h3>
    <div class="controls">
        <label>sellerId <input id="dbgSellerId" value="1" /></label>
      <label>storeId <input id="dbgStoreId" value="" /></label>
      <label>slug <input id="dbgSlug" value="" /></label>
        <button id="dbgLoadStore">Load Store</button>
      <button id="dbgFetchStore">Fetch Store (raw)</button>
      <button id="dbgFetchProducts">Fetch Products (raw)</button>
      <button id="dbgClear">Clear Output</button>
    </div>

    <h4>Last responses</h4>
    <div id="debugOutput">
      <pre id="dbgOut">(no output yet)</pre>
    </div>
  </section>
  </div>

  <!-- Load Components (Header & Footer) -->
  <script src="../js/load-components.js"></script>

  <!-- API Configuration and Integration -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/app.js"></script>
  <script>
    // ====== STORE PAGE LOGIN REQUIREMENT ======
    // When seller shares store link, user MUST login first, then see store
    
    // Check if user is logged in
    function isUserLoggedIn() {
      try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        const rememberUser = localStorage.getItem('rememberUser');
        return currentUser && rememberUser === 'true';
      } catch (e) {
        return false;
      }
    }
    
    // Show/hide store content based on login status
    function updateStorePageVisibility() {
      const isLoggedIn = isUserLoggedIn();
      const storeContent = document.getElementById('store-content');
      const loginRequiredMsg = document.getElementById('login-required-message');
      const loginModalOverlay = document.getElementById('loginModalOverlay');
      
      if (isLoggedIn) {
        // User is logged in - show store content
        if (storeContent) storeContent.style.display = 'block';
        if (loginRequiredMsg) loginRequiredMsg.style.display = 'none';
        if (loginModalOverlay) loginModalOverlay.style.display = 'none';
        
        // Load store page
        loadStorePageContent();
      } else {
        // User is NOT logged in - show login modal and hide store
        if (storeContent) storeContent.style.display = 'none';
        if (loginRequiredMsg) loginRequiredMsg.style.display = 'block';
        
        // Show login modal (if available)
        if (loginModalOverlay && typeof window.openLoginModal === 'function') {
          setTimeout(() => {
            window.openLoginModal();
          }, 300);
        }
      }
    }
    
    // Load store page content (only called after login)
    function loadStorePageContent() {
      setTimeout(function() {
        if (typeof window.loadStorePage === 'function') {
          console.log('Loading store page...');
          window.loadStorePage().catch(function(err) {
            console.error('Error loading store page:', err);
          });
        } else {
          console.warn('loadStorePage function not found');
        }
      }, 500);
    }
    
    // Listen for login success (when user logs in)
    function setupLoginListener() {
      // Listen for custom login success event (dispatched from index.html login handler)
      window.addEventListener('userLoggedIn', () => {
        console.log('Login detected on store page - loading store content');
        updateStorePageVisibility();
      });
      
      // Also check login status periodically (fallback in case event doesn't fire)
      let checkCount = 0;
      const maxChecks = 20; // Check for 10 seconds (20 * 500ms)
      const checkInterval = setInterval(() => {
        checkCount++;
        if (isUserLoggedIn()) {
          clearInterval(checkInterval);
          updateStorePageVisibility();
        } else if (checkCount >= maxChecks) {
          clearInterval(checkInterval);
        }
      }, 500);
      
      // Listen for storage changes (when login happens in another tab)
      window.addEventListener('storage', (e) => {
        if (e.key === 'currentUser' || e.key === 'rememberUser') {
          updateStorePageVisibility();
        }
      });
    }
    
    // ====== LOGIN HANDLERS (Required for store page) ======
    // These functions are needed for the login modal to work on store.html
    
    // Get backend URL
    const getBackendUrl = () => {
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:8080/api';
      }
      return `${protocol}//${hostname}:8080/api`;
    };
    
    const API_BASE = window.API_BASE || getBackendUrl();
    
    const UserAPI = {
      sendOtp: async (phone) => {
        const response = await fetch(`${API_BASE}/user/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: `Server error: ${response.status}` }));
          throw new Error(error.message || `HTTP error! status: ${response.status}`);
        }
        return response.json();
      },
      verifyOtp: async (phone, code) => {
        const response = await fetch(`${API_BASE}/user/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, code })
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: `Server error: ${response.status}` }));
          throw new Error(error.message || `HTTP error! status: ${response.status}`);
        }
        return response.json();
      }
    };
    
    let currentPhoneNumber = '';
    let currentUserName = '';
    
    async function handlePhoneLogin(e) {
      e.preventDefault();
      const nameInput = document.getElementById('loginName');
      const phoneInput = document.getElementById('loginPhone');
      if (!nameInput || !phoneInput) {
        alert('Login form not found. Please refresh.');
        return;
      }
      
      const name = nameInput.value.trim();
      const phone = phoneInput.value.replace(/\D/g, '');
      
      if (name.length < 2) {
        alert('Please enter your full name (at least 2 characters)');
        return;
      }
      
      if (phone.length !== 10) {
        alert('Please enter a valid 10-digit phone number');
        return;
      }
      
      currentUserName = name;
      currentPhoneNumber = phone;
      localStorage.setItem('pendingName', name);
      localStorage.setItem('pendingPhone', phone);
      
      const submitBtn = phoneInput.closest('form')?.querySelector('button[type="submit"]');
      const originalText = submitBtn?.textContent || 'Get OTP';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
      }
      
      try {
        const response = await UserAPI.sendOtp(phone);
        if (response.otp) console.log('OTP:', response.otp);
        
        const loginFormContainer = document.getElementById('loginFormContainer');
        const otpFormContainer = document.getElementById('otpFormContainer');
        
        if (loginFormContainer) loginFormContainer.style.display = 'none';
        if (otpFormContainer) {
          otpFormContainer.style.display = 'block';
          otpFormContainer.style.visibility = 'visible';
        }
        
        const maskedPhone = `+91*****${phone.slice(-4)}`;
        const otpPhoneDisplay = document.getElementById('otpPhoneDisplay');
        if (otpPhoneDisplay) {
          otpPhoneDisplay.textContent = `We have sent a code by sms to ${maskedPhone}.`;
        }
        
        const otpInput = document.getElementById('otpInput');
        if (otpInput) {
          otpInput.value = '';
          otpInput.focus();
        }
        
        alert(`OTP sent to ${maskedPhone}`);
      } catch (error) {
        console.error('Failed to send OTP:', error);
        alert(error.message || 'Failed to send OTP. Please try again.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    }
    
    async function handleOTPVerification(e) {
      e.preventDefault();
      const enteredOTP = document.getElementById('otpInput')?.value.trim();
      const phone = currentPhoneNumber || localStorage.getItem('pendingPhone');
      
      if (!enteredOTP || enteredOTP.length !== 6) {
        alert('Please enter complete 6-digit OTP');
        return;
      }
      
      if (!phone) {
        alert('Phone number not found. Please start over.');
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn?.textContent || 'Verify OTP';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';
      }
      
      try {
        const storedName = currentUserName || localStorage.getItem('pendingName') || '';
        const response = await UserAPI.verifyOtp(phone, enteredOTP);
        
        const userName = storedName || response.fullName || `User ${phone.slice(-4)}`;
        const currentUser = {
          id: response.userId,
          userId: response.userId,
          name: userName,
          fullName: userName,
          phone: response.phone || phone,
          token: response.token
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('rememberUser', 'true');
        localStorage.removeItem('pendingPhone');
        localStorage.removeItem('pendingName');
        currentPhoneNumber = '';
        currentUserName = '';
        
        // Dispatch login success event
        window.dispatchEvent(new CustomEvent('userLoggedIn', { detail: { user: currentUser } }));
        
        // Close modal
        const loginModalOverlay = document.getElementById('loginModalOverlay');
        if (loginModalOverlay) {
          loginModalOverlay.style.display = 'none';
          loginModalOverlay.classList.remove('active');
        }
        
        alert('Login successful!');
        
        // Update store page visibility
        updateStorePageVisibility();
      } catch (error) {
        console.error('OTP verification failed:', error);
        alert(error.message || 'Invalid OTP. Please try again.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    }
    
    // Make functions globally available
    window.handlePhoneLogin = handlePhoneLogin;
    window.handleOTPVerification = handleOTPVerification;
    window.openLoginModal = function() {
      const overlay = document.getElementById('loginModalOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    };
    window.closeLoginModal = function() {
      const overlay = document.getElementById('loginModalOverlay');
      if (overlay) {
        overlay.style.display = 'none';
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    };
    
    // Initialize login form handlers
    document.addEventListener('DOMContentLoaded', function() {
      // Phone form
      const phoneForm = document.getElementById('loginPhoneForm');
      if (phoneForm) {
        phoneForm.addEventListener('submit', handlePhoneLogin);
      }
      
      // OTP form
      const otpForm = document.getElementById('otpForm');
      if (otpForm) {
        otpForm.addEventListener('submit', handleOTPVerification);
      }
      
      // Close button
      const closeBtn = document.getElementById('loginModalClose');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          window.closeLoginModal();
        });
      }
      
      // Overlay click
      const overlay = document.getElementById('loginModalOverlay');
      if (overlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            window.closeLoginModal();
          }
        });
      }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for scripts to load
      setTimeout(() => {
        // First check login status
        updateStorePageVisibility();
        
        // Setup listener for login
        setupLoginListener();
        
        // Ensure login modal is enabled on store page (not disabled by app.js)
        const loginModalOverlay = document.getElementById('loginModalOverlay');
        if (loginModalOverlay) {
          // Re-enable login modal if it was disabled
          loginModalOverlay.style.display = '';
          loginModalOverlay.style.visibility = '';
          loginModalOverlay.style.opacity = '';
          loginModalOverlay.style.pointerEvents = '';
        }
        
        // Also check after a delay (in case scripts load slowly)
        setTimeout(updateStorePageVisibility, 1000);
      }, 600); // Wait for scripts to load
    });
    
    // Debug helpers
    function addDebug(msg) {
      const out = document.getElementById('dbgOut');
      out.textContent = (new Date()).toLocaleTimeString() + ' — ' + msg + '\n\n' + out.textContent;
    }

    function pretty(obj) {
      try { return JSON.stringify(obj, null, 2); } catch (e) { return String(obj); }
    }

    // Wait for app.js to load before setting up event listeners
    function setupDebugButtons() {
      const dbgLoadStore = document.getElementById('dbgLoadStore');
      if (!dbgLoadStore) return;

      dbgLoadStore.addEventListener('click', () => {
      // call loadStorePage from app.js which will render into the page
      try {
          // Wait a bit for app.js to finish loading
        if (typeof window.loadStorePage === 'function') {
          // set URL params temporarily then call
          const sellerId = document.getElementById('dbgSellerId').value || '';
          const storeId = document.getElementById('dbgStoreId').value || '';
          const slug = document.getElementById('dbgSlug').value || '';
          const params = new URLSearchParams(window.location.search);
          if (sellerId) params.set('sellerId', sellerId); else params.delete('sellerId');
          if (storeId) params.set('storeId', storeId); else params.delete('storeId');
          if (slug) params.set('slug', slug); else params.delete('slug');
          const newUrl = window.location.pathname + '?' + params.toString();
          history.replaceState({}, '', newUrl);
          window.loadStorePage();
          addDebug('Called loadStorePage() with ' + params.toString());
        } else {
            addDebug('loadStorePage() not found in app.js. Waiting...');
            // Retry after a short delay
            setTimeout(() => {
              if (typeof window.loadStorePage === 'function') {
                window.loadStorePage();
                addDebug('loadStorePage() found and called after retry');
              } else {
                addDebug('loadStorePage() still not found. Check if app.js loaded correctly.');
              }
            }, 500);
        }
      } catch (e) { addDebug('Error: ' + e.message); }
    });
    }

    // Setup when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupDebugButtons);
    } else {
      // DOM already loaded, wait a bit for scripts
      setTimeout(setupDebugButtons, 100);
    }
    
    // Show debug section only if ?debug=true in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('debug') === 'true') {
      const debugSection = document.getElementById('debug-section');
      if (debugSection) {
        debugSection.classList.add('visible');
      }
    }

    document.getElementById('dbgFetchStore').addEventListener('click', async () => {
      const sellerId = document.getElementById('dbgSellerId').value || '';
      const storeId = document.getElementById('dbgStoreId').value || '';
      const slug = document.getElementById('dbgSlug').value || '';
      let url = '';
      if (storeId) url = `${window.API_BASE.replace(/\/$/, '')}/api/stores/${encodeURIComponent(storeId)}`;
      else if (slug) url = `${window.API_BASE.replace(/\/$/, '')}/api/stores/slug/${encodeURIComponent(slug)}`;
      else if (sellerId) url = `${window.API_BASE.replace(/\/$/, '')}/api/stores/seller?sellerId=${encodeURIComponent(sellerId)}`;
      if (!url) { addDebug('No parameter provided (sellerId/storeId/slug)'); return; }
      addDebug('Fetching ' + url);
      try {
        const res = await fetch(url);
        const text = await res.text();
        addDebug('Status ' + res.status + '\n' + text);
      } catch (e) {
        addDebug('Error: ' + e.message);
      }
    });

    document.getElementById('dbgFetchProducts').addEventListener('click', async () => {
      const sellerId = document.getElementById('dbgSellerId').value || '';
      if (!sellerId) { addDebug('Provide sellerId to fetch products'); return; }
      // Try the direct query URL you provided first, then fallback to sellerProducts
      const base = window.API_BASE.replace(/\/$/, '');
      const urls = [
        `${base}/api/products?sellerId=${encodeURIComponent(sellerId)}`,
        `${base}/api/products/sellerProducts?sellerId=${encodeURIComponent(sellerId)}`
      ];
      for (const url of urls) {
        addDebug('Fetching ' + url);
        try {
          const res = await fetch(url);
          const text = await res.text();
          addDebug('Status ' + res.status + '\n' + text);
          // stop after first successful response (200)
          if (res.ok) break;
        } catch (e) {
          addDebug('Error: ' + e.message);
        }
      }
    });

    document.getElementById('dbgClear').addEventListener('click', () => {
      document.getElementById('dbgOut').textContent = '(no output yet)';
    });
  </script>
</body>
</html>