<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category | V Store</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: var(--bg-color, #f5f5f5);
      color: var(--text-color, #333);
      transition: background-color 0.3s, color 0.3s;
    }

    .filters-section {
      background: var(--card-bg, #fff);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .back-link {
      text-decoration: none;
      background: #007BFF;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-link:hover {
      background: #0056b3;
    }

    select {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.95rem;
      background: var(--bg-color, #fff);
      color: var(--text-color, #333);
      cursor: pointer;
      transition: border-color 0.3s, background-color 0.3s;
    }
    
    body.dark-mode select {
      border-color: rgba(255,255,255,0.1);
    }

    .category-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 30px;
      color: var(--text-color, #333);
      transition: color 0.3s;
    }

    @media (max-width: 768px) {
      .top-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .filters {
        width: 100%;
      }
      select {
        flex: 1;
        min-width: 120px;
      }
      .category-title {
        font-size: 1.75rem;
      }
    }
    
    @media (max-width: 480px) {
      .filters-section {
        padding: 16px;
      }
      .filters {
        flex-direction: column;
        width: 100%;
      }
      select {
        width: 100%;
      }
      .category-title {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <header class="topbar">
      <div class="topbar-inner container">
        <div class="left-group">
          <div class="avatar" aria-hidden="true">
            <a href="../index.html" style="text-decoration:none;color:inherit;display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><span>V</span></a>
          </div>
          <div class="divider"></div>
          <nav class="main-nav" aria-label="Main">
            <a href="categories.html" class="nav-item">Categories</a>
            <a href="featured.html" class="nav-item">Featured</a>
            <a href="products.html" class="nav-item">Products</a>
          </nav>
          <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle Menu">☰</button>
        </div>
        <div class="right-group">
          <!-- Dark Mode Toggle Switch -->
          <div class="dark-mode-toggle-container">
            <label class="dark-mode-toggle" for="dark-mode-switch" title="Toggle Dark Mode">
              <input type="checkbox" id="dark-mode-switch" class="toggle-input">
              <span class="toggle-track">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="4"></circle>
                  <line x1="12" y1="1" x2="12" y2="3"></line>
                  <line x1="12" y1="21" x2="12" y2="23"></line>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                  <line x1="1" y1="12" x2="3" y2="12"></line>
                  <line x1="21" y1="12" x2="23" y2="12"></line>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <span class="toggle-indicator"></span>
              </span>
            </label>
          </div>

          <button class="icon-btn" id="searchBtn" title="Search Products">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="6" stroke-width="1.6"></circle>
              <path d="M21 21l-4.35-4.35" stroke-width="1.6" stroke-linecap="round"></path>
            </svg>
          </button>

          <button class="icon-btn" id="wishlistBtn" title="Wishlist" onclick="window.location.href='wishlist.html'">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke-width="1.5" stroke-linejoin="round"></path>
            </svg>
            <span class="wishlist-count" id="wishlistCount">0</span>
          </button>
          <button class="icon-btn" id="cartBtn" title="Cart" onclick="window.location.href='cart.html'">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
              <path d="M6 6h15l-1.5 9h-12z" stroke-width="1.5" stroke-linejoin="round"></path>
              <circle cx="10" cy="20" r="1.4" stroke-width="1.5"></circle>
              <circle cx="18" cy="20" r="1.4" stroke-width="1.5"></circle>
            </svg>
            <span class="cart-count" id="cartCount">0</span>
          </button>

          <!-- Profile Button -->
          <button class="icon-btn" id="profileBtn" title="Profile" onclick="openProfileSidebar()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </button>
        </div>
      </div>
    </header>

  <!-- Profile Sidebar Menu -->
  <div class="profile-sidebar-overlay" id="profileSidebarOverlay"></div>
  <div class="profile-sidebar" id="profileSidebar">
    <div class="profile-sidebar-header">
      <button class="profile-sidebar-close" id="profileSidebarClose" aria-label="Close Menu">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="profile-sidebar-content">
      <div class="profile-sidebar-user">
        <div class="profile-sidebar-avatar">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="profile-sidebar-info">
          <div class="profile-sidebar-name">Hello User</div>
          <div class="profile-sidebar-phone">+1234567890</div>
        </div>
      </div>
      <div class="profile-sidebar-menu">
        <a href="cart.html" class="profile-sidebar-item" id="sidebarMyOrders">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <span>My Orders</span>
        </a>
        <div class="profile-sidebar-item" id="sidebarLightMode">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
            <circle cx="8" cy="12" r="3"></circle>
          </svg>
          <span id="sidebarLightModeText">Light Mode</span>
        </div>
        <a href="login.html" class="profile-sidebar-item" id="sidebarSignOut">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span>Sign Out</span>
        </a>
      </div>
    </div>
  </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div class="search-modal-content" style="background: var(--card-bg, #fff); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); position: relative;">
        <h3 style="margin-bottom: 20px; color: var(--text-color, #333); font-size: 1.5rem;">Search Products</h3>
        <div style="position: relative; margin-bottom: 20px;">
          <input type="text" class="search-input" id="searchInput" placeholder="Search for products..." autocomplete="off" style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 1rem; background: var(--bg-color, #fff); color: var(--text-color, #333); transition: border-color 0.3s;">
          <button class="search-close" id="searchClose" style="position: absolute; top: 50%; right: 12px; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color, #666); padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div class="search-results" id="searchResults" style="max-height: 400px; overflow-y: auto;">
          <!-- Search results will appear here -->
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" id="mobileNav">
      <a href="categories.html" class="nav-item">Categories</a>
      <a href="featured.html" class="nav-item">Featured</a>
      <a href="products.html" class="nav-item">Products</a>
      <a href="cart.html" class="nav-item">Cart</a>
      <a href="login.html" class="nav-item">Login</a>
    </nav>
    
    <main style="flex: 1;">
      <div class="container" style="padding: 30px 20px;">
        <div class="filters-section">
    <div class="top-row">
      <a href="categories.html" class="back-link">← Back to Categories</a>
      <div class="filters">
        <select id="colorFilter">
          <option value="all">All Colors</option>
          <option value="Black">Black</option>
          <option value="White">White</option>
          <option value="Blue">Blue</option>
          <option value="Grey">Grey</option>
        </select>
        <select id="sizeFilter">
          <option value="all">All Sizes</option>
          <option value="S">Small (S)</option>
          <option value="M">Medium (M)</option>
          <option value="L">Large (L)</option>
          <option value="XL">Extra Large (XL)</option>
        </select>
        <select id="sortSelect">
          <option value="default">Sort by</option>
          <option value="lowToHigh">Price: Low to High</option>
          <option value="highToLow">Price: High to Low</option>
        </select>
      </div>
          </div>
        </div>

        <h1 class="category-title" id="category-title">Category</h1>
        <div class="ecommerce-grid" id="product-grid"></div>
      </div>
    </main>
  
  <!-- Footer Component (loaded from components/footer.html) -->
  <div id="footer-placeholder" style="width: 100%; margin-top: auto; flex-shrink: 0;"></div>
  
  <!-- Load components first, then app.js -->
  <script src="../js/load-components.js"></script>
  <script>
    const products = {
      "Casual Wear": [
        { name: "Casual Shirt", image: "../assets/products/cs.jpg", price: 29, color: "Blue", size: "M" },
        { name: "Relaxed Polo", image: "../assets/genz/w1.webp", price: 35, color: "White", size: "L" }
      ],
      "T-Shirts": [
        { name: "Graphic Tee", image: "../assets/genz/ts.webp", price: 19, color: "Black", size: "S" },
          { name: "Plain T-Shirt", image: "../assets/genz/w2.webp", price: 15, color: "White", size: "M" }
      ],
      "Jeans": [
        { name: "Slim Fit Jeans", image: "../assets/genz/Bg.jpg", price: 40, color: "Blue", size: "L" },
        { name: "Distressed Jeans", image: "../assets/genz/w3.webp", price: 45, color: "Black", size: "XL" }
      ],
      "Hoodies": [
        { name: "Pullover Hoodie", image: "../assets/genz/hd.webp", price: 50, color: "Grey", size: "M" },
        { name: "Zip Hoodie", image: "../assets/genz/w4.jpg", price: 55, color: "Black", size: "L" }
      ],
      "Lowers & Joggers": [
        { name: "Cotton Joggers", image: "../assets/genz/ls.webp", price: 30, color: "Grey", size: "M" },
        { name: "Track Pants", image: "../assets/genz/w5.webp", price: 28, color: "Black", size: "S" }
      ],
      "Co-ord Sets": [
        { name: "Summer Co-ord", image: "../assets/genz/cd.webp", price: 60, color: "White", size: "L" },
        { name: "Winter Co-ord", image: "../assets/genz/w6.webp", price: 70, color: "Black", size: "XL" }
      ]
    };

    function getCategoryFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("name");
    }

      const category = decodeURIComponent(getCategoryFromURL() || "");
    const title = document.getElementById("category-title");
    const grid = document.getElementById("product-grid");

    function getFilters() {
      return {
        color: document.getElementById("colorFilter").value,
        size: document.getElementById("sizeFilter").value,
        sort: document.getElementById("sortSelect").value
      };
    }

    async function filterAndDisplayProducts() {
      if (!category) {
        grid.innerHTML = "<p style='text-align:center;padding:40px;color:var(--text-color);'>No category specified.</p>";
        return;
      }

      title.textContent = category;
      
      // Show loading state
      grid.innerHTML = "<p style='text-align:center;padding:40px;color:var(--text-color);'>Loading products...</p>";

      // Try fetching from backend API first
      let fetched = [];
      try {
        if (window.API && typeof window.API.getProductsByCategory === 'function') {
          console.log('Fetching products for category:', category);
          fetched = await window.API.getProductsByCategory(category);
          console.log('Products fetched from API:', fetched);
        } else if (typeof fetchProductsByCategory === 'function') {
          // Fallback to app.js function
          fetched = await fetchProductsByCategory(category);
        }
      } catch (e) {
        console.warn('Error fetching products by category, falling back to local:', e);
        fetched = null;
      }

      // Normalize products: convert API format to display format
      let allProducts = [];
      if (fetched && Array.isArray(fetched) && fetched.length > 0) {
        allProducts = fetched.map(p => ({
          id: p.productId || p.id,
          name: p.productName || p.name || 'Unknown Product',
          image: (p.productImages && p.productImages[0]) || p.image || p.imageUrl || '../assets/products/p1.jpg',
          price: p.sellingPrice ?? p.price ?? 0,
          mrp: p.mrp || p.originalPrice || p.price || 0,
          color: p.color || p.colour || p.variantColor || 'N/A',
          size: p.size || p.availableSize || 'N/A',
          brand: p.brand || 'V Store',
          raw: p
        }));
      } else if (products[category]) {
        // Fallback to hardcoded data if API fails
        console.warn('Using fallback hardcoded data for category:', category);
        allProducts = products[category].map(p => ({
          name: p.name,
          image: p.image,
          price: p.price,
          mrp: p.price,
          color: p.color || 'N/A',
          size: p.size || 'N/A',
          brand: 'V Store'
        }));
      }

      if (allProducts.length === 0) {
        grid.innerHTML = "<p style='text-align:center;padding:40px;color:var(--text-color);'>No products found for this category.</p>";
        return;
      }

      // Apply filters
      const { color, size, sort } = getFilters();
      let filtered = [...allProducts];

      if (color !== "all") {
        filtered = filtered.filter(p => p.color === color);
      }

      if (size !== "all") {
        filtered = filtered.filter(p => p.size === size);
      }

      if (sort === "lowToHigh") {
        filtered.sort((a, b) => a.price - b.price);
      } else if (sort === "highToLow") {
        filtered.sort((a, b) => b.price - a.price);
      }

      if (filtered.length === 0) {
          grid.innerHTML = "<p style='text-align:center;padding:40px;color:var(--text-color);'>No matching products found.</p>";
        return;
      }

      // Helper function to check if product is in wishlist
      function isProductInWishlist(productName) {
        if (window.WishlistUtils) {
          const wishlist = window.WishlistUtils.getWishlist();
          return wishlist.some(item => item.name === productName);
        } else {
          const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
          return wishlist.some(item => item.name === productName);
        }
      }

      // Helper function to get wishlist button HTML
      function getWishlistButtonHTML(product) {
        const isWishlisted = isProductInWishlist(product.name);
        const wishlistIcon = isWishlisted 
          ? `<img src="../assets/gifs/wishlist.gif" alt="Wishlisted" style="width: 20px; height: 20px; object-fit: contain;" />`
          : `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>`;
        
        const title = isWishlisted ? 'Remove from Wishlist' : 'Add to Wishlist';
        
        return `<button class="wishlist-btn" data-name="${product.name}" data-price="${product.price}" data-brand="V Store" data-img="${product.image}" onclick="event.stopPropagation(); addToWishlistFromProduct(this)" title="${title}" style="padding: 12px; min-width: 48px; height: 48px; background: var(--muted-white, #f5f5f5); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
          ${wishlistIcon}
        </button>`;
      }

      grid.innerHTML = filtered.map(product => {
        const productId = product.id || '';
        const productUrl = `product-detail.html?id=${productId}${productId ? '' : '&name=' + encodeURIComponent(product.name)}`;
        const discount = product.mrp > product.price ? Math.round(((product.mrp - product.price) / product.mrp) * 100) : 0;
        
        const isBestseller = product.isBestseller || product.raw?.isBestseller || false;
        
        return `
          <div class="ecommerce-product-card">
            <a href="${productUrl}" style="text-decoration: none; color: inherit;">
              <div class="product-image-wrapper" style="position: relative;">
                ${isBestseller ? `<span class="bestseller-badge" style="position: absolute; top: 8px; left: 8px; background: #FFD700; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; z-index: 2;">Bestseller</span>` : ''}
                <img src="${product.image}" alt="${product.name}" onerror="this.src='../assets/products/p1.jpg'" />
                ${discount > 0 ? `<span class="discount-badge">${discount}% OFF</span>` : ''}
              </div>
            </a>
            <div class="product-info">
              <div class="product-brand">${product.brand || 'V Store'}</div>
              <div class="product-name">${product.name}</div>
              <div class="product-price">
                <span class="current-price">₹${product.price}</span>
                ${product.mrp > product.price ? `<span class="original-price">₹${product.mrp}</span>` : ''}
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="add-to-cart-btn" data-name="${product.name}" data-price="${product.price}" data-id="${productId}" style="flex: 1;">Add to Cart</button>
                ${getWishlistButtonHTML(product)}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    // Helper function to update wishlist button icon
    function updateWishlistButtonIcon(button, isWishlisted) {
      if (isWishlisted) {
        // Replace with GIF
        button.innerHTML = `<img src="../assets/gifs/wishlist.gif" alt="Wishlisted" style="width: 20px; height: 20px; object-fit: contain;" />`;
        button.title = 'Remove from Wishlist';
      } else {
        // Replace with SVG
        button.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>`;
        button.title = 'Add to Wishlist';
      }
    }

    // Add to wishlist from product card
    function addToWishlistFromProduct(button) {
      const name = button.getAttribute('data-name');
      const price = parseInt(button.getAttribute('data-price'));
      const brand = button.getAttribute('data-brand') || 'V Store';
      const img = button.getAttribute('data-img') || '';
      
      // Check if product is already in wishlist
      const isCurrentlyWishlisted = isProductInWishlist(name);
      
      if (window.WishlistUtils) {
        if (isCurrentlyWishlisted) {
          // Remove from wishlist
          window.WishlistUtils.removeItemFromWishlist(name);
          updateWishlistButtonIcon(button, false);
          if (window.showToast) {
            showToast(`${name} removed from wishlist`, 'success', 'Wishlist');
          }
        } else {
          // Add to wishlist
          const added = window.WishlistUtils.addItemToWishlist({
            name: name,
            price: price,
            originalPrice: price,
            image: img,
            brand: brand,
            size: 'Default',
            color: 'Default'
          });
          
          if (added) {
            updateWishlistButtonIcon(button, true);
            if (window.showToast) {
              showToast(`${name} added to wishlist!`, 'success', 'Wishlist');
            }
          }
        }
        
        window.WishlistUtils.updateWishlistCount();
      } else {
        // Fallback to localStorage
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        const existingItemIndex = wishlist.findIndex(item => item.name === name);
        
        if (existingItemIndex !== -1) {
          // Remove from wishlist
          wishlist.splice(existingItemIndex, 1);
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
          updateWishlistButtonIcon(button, false);
          if (window.showToast) {
            showToast(`${name} removed from wishlist`, 'success', 'Wishlist');
          }
        } else {
          // Add to wishlist
          wishlist.push({
            name: name,
            price: price,
            originalPrice: price,
            image: img,
            brand: brand
          });
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
          updateWishlistButtonIcon(button, true);
          if (window.showToast) {
            showToast(`${name} added to wishlist!`, 'success', 'Wishlist');
          }
        }
        
        // Update wishlist count
        const wishlistCountElements = document.querySelectorAll('#wishlistCount, .wishlist-count');
        wishlistCountElements.forEach(el => {
          if (el) {
            el.textContent = wishlist.length;
            if (wishlist.length > 0) {
              el.style.display = 'inline-block';
            } else {
              el.style.display = 'none';
            }
          }
        });
      }
    }

    // Make function globally available
    window.addToWishlistFromProduct = addToWishlistFromProduct;
    window.isProductInWishlist = isProductInWishlist;
    window.updateWishlistButtonIcon = updateWishlistButtonIcon;

    // Wait for API to load, then fetch products
    if (category) {
      // Wait for API to be ready
      const checkAndLoad = () => {
        if (window.API && typeof window.API.getProductsByCategory === 'function') {
          filterAndDisplayProducts();
        } else {
          // Retry after a short delay
          setTimeout(checkAndLoad, 200);
        }
      };
      checkAndLoad();
    }

    document.getElementById("colorFilter").addEventListener("change", filterAndDisplayProducts);
    document.getElementById("sizeFilter").addEventListener("change", filterAndDisplayProducts);
    document.getElementById("sortSelect").addEventListener("change", filterAndDisplayProducts);
  </script>
    <!-- API Configuration and Integration -->
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
      // Search functionality
      const searchBtn = document.getElementById('searchBtn');
      const searchModal = document.getElementById('searchModal');
      const searchInput = document.getElementById('searchInput');
      const searchClose = document.getElementById('searchClose');
      const searchResults = document.getElementById('searchResults');

      // Product data for search
      const allProducts = [
        { name: 'Colourblocked Polo T-shirt', price: 593, img: 'products.html', brand: 'Allen Solly' },
        { name: 'Pure Cotton Custom Fit Shirt', price: 917, img: 'products.html', brand: 'Allen Solly' },
        { name: 'Polo Collar Slim Fit T-shirt', price: 929, img: 'products.html', brand: 'Louis Philippe Jeans' },
        { name: 'Pure Cotton Casual Shirt', price: 993, img: 'products.html', brand: 'Allen Solly' },
        { name: 'Classic Fit Formal Shirt', price: 849, img: 'products.html', brand: 'Louis Philippe Jeans' },
        { name: 'Regular Fit Cotton T-shirt', price: 699, img: 'products.html', brand: 'Allen Solly' },
        { name: 'Slim Fit Cotton Shirt', price: 799, img: 'products.html', brand: 'Louis Philippe Jeans' },
        { name: 'Oversized Graphic Tee', price: 499, img: 'featured.html', brand: 'V Store' },
        { name: 'Minimalist Hoodie', price: 799, img: 'featured.html', brand: 'V Store' },
        { name: 'Baggy Fit Jeans', price: 999, img: 'featured.html', brand: 'V Store' },
        { name: 'Co-ord Set', price: 1199, img: 'featured.html', brand: 'V Store' }
      ];

      function performSearch(query) {
        const lowerQuery = query.toLowerCase().trim();
        if (lowerQuery === '') {
          searchResults.innerHTML = '';
          return;
        }

        const filtered = allProducts.filter(p => 
          p.name.toLowerCase().includes(lowerQuery) ||
          p.brand.toLowerCase().includes(lowerQuery)
        );

        searchResults.innerHTML = '';
        
        if (filtered.length === 0) {
          searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-color, #666);">No products found</div>';
          return;
        }

        filtered.forEach(product => {
          const item = document.createElement('div');
          item.style.cssText = 'padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px;';
          item.innerHTML = `
            <div style="flex: 1;">
              <h4 style="margin: 0 0 4px 0; color: var(--text-color, #333); font-size: 1rem;">${product.name}</h4>
              <p style="margin: 0; color: #e53935; font-weight: 600; font-size: 0.9rem;">₹${product.price}</p>
              <p style="margin: 4px 0 0 0; color: var(--text-color, #666); font-size: 0.85rem;">${product.brand}</p>
            </div>
          `;
          item.addEventListener('mouseenter', () => {
            item.style.background = 'var(--muted-white, #f5f5f5)';
          });
          item.addEventListener('mouseleave', () => {
            item.style.background = 'transparent';
          });
          item.addEventListener('click', () => {
            window.location.href = product.img;
            searchModal.style.display = 'none';
            searchInput.value = '';
            searchResults.innerHTML = '';
          });
          searchResults.appendChild(item);
        });
      }

      if (searchBtn) {
        searchBtn.addEventListener('click', () => {
          searchModal.style.display = 'flex';
          setTimeout(() => searchInput.focus(), 100);
        });
      }

      if (searchClose) {
        searchClose.addEventListener('click', () => {
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        });
      }

      if (searchModal) {
        searchModal.addEventListener('click', (e) => {
          if (e.target === searchModal) {
            searchModal.style.display = 'none';
            searchInput.value = '';
            searchResults.innerHTML = '';
          }
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          performSearch(e.target.value);
        });
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            searchModal.style.display = 'none';
            searchInput.value = '';
            searchResults.innerHTML = '';
          }
        });
      }

      // Mobile Menu Toggle
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const mobileNav = document.getElementById("mobileNav");
      if (mobileMenuBtn && mobileNav) {
        mobileMenuBtn.addEventListener("click", () => {
          mobileNav.classList.toggle("active");
        });
        document.addEventListener("click", (e) => {
          if (!mobileMenuBtn.contains(e.target) && !mobileNav.contains(e.target)) {
            mobileNav.classList.remove("active");
          }
        });
        mobileNav.querySelectorAll(".nav-item").forEach(item => {
          item.addEventListener("click", () => {
            mobileNav.classList.remove("active");
          });
        });
      }

      // Profile Sidebar Toggle
      const profileSidebar = document.getElementById('profileSidebar');
      const profileSidebarOverlay = document.getElementById('profileSidebarOverlay');
      const profileSidebarClose = document.getElementById('profileSidebarClose');
      const sidebarLightModeBtn = document.getElementById('sidebarLightMode');

      function openProfileSidebar() {
        if (profileSidebar) {
          profileSidebar.classList.add('active');
          if (profileSidebarOverlay) {
            profileSidebarOverlay.classList.add('active');
          }
          document.body.style.overflow = 'hidden';
        }
      }

      function closeProfileSidebar() {
        if (profileSidebar) {
          profileSidebar.classList.remove('active');
          if (profileSidebarOverlay) {
            profileSidebarOverlay.classList.remove('active');
          }
          document.body.style.overflow = '';
        }
      }

      // Close sidebar
      if (profileSidebarClose) {
        profileSidebarClose.addEventListener('click', () => {
          closeProfileSidebar();
        });
      }

      // Close sidebar when clicking overlay
      if (profileSidebarOverlay) {
        profileSidebarOverlay.addEventListener('click', () => {
          closeProfileSidebar();
        });
      }

      // Close sidebar on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && profileSidebar && profileSidebar.classList.contains('active')) {
          closeProfileSidebar();
        }
      });

      // Light Mode toggle from sidebar
      if (sidebarLightModeBtn) {
        sidebarLightModeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const darkModeSwitch = document.getElementById('dark-mode-switch');
          if (darkModeSwitch) {
            darkModeSwitch.checked = !darkModeSwitch.checked;
            darkModeSwitch.dispatchEvent(new Event('change'));
          }
        });
      }

      // Update Light Mode text based on current theme
      function updateLightModeText() {
        const sidebarLightModeText = document.getElementById('sidebarLightModeText');
        const isDarkMode = document.body.classList.contains('dark-mode');
        
        if (sidebarLightModeText) {
          sidebarLightModeText.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
        }
      }

      // Update on theme change (wait for app.js to initialize first)
      function setupLightModeTextUpdate() {
        const darkModeSwitch = document.getElementById('dark-mode-switch');
        if (!darkModeSwitch) {
          setTimeout(setupLightModeTextUpdate, 50);
          return;
        }
        darkModeSwitch.addEventListener('change', function() {
          requestAnimationFrame(updateLightModeText);
        });
        updateLightModeText();
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(setupLightModeTextUpdate, 150);
        });
      } else {
        setTimeout(setupLightModeTextUpdate, 150);
      }

      // Close sidebar when clicking menu items (except light mode toggle)
      const sidebarMenuItems = document.querySelectorAll('.profile-sidebar-item');
      sidebarMenuItems.forEach(item => {
        if (item.id !== 'sidebarLightMode') {
          item.addEventListener('click', () => {
            setTimeout(() => {
              closeProfileSidebar();
            }, 100);
          });
        }
      });
    </script>
  </div>
</body>
</html>
