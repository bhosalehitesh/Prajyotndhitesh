<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Login | V Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
/* ===== Reset & Base ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
html {
  height: 100%;
  background-color: var(--bg-color);
  transition: background-color 0.3s;
}

html.dark-mode {
  background-color: var(--bg-color);
}

body {
  height: 100%;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color: var(--text-color);
  background-color: var(--bg-color);
  transition: background-color 0.3s, color 0.3s;
}

body.dark-mode {
  background-color: var(--bg-color);
}

/* ===== Page Layout ===== */
html {
  height: 100%;
}

body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  height: 100%;
}

.page-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100%;
}

.page-wrapper > .topbar {
  position: sticky;
  top: 0;
  z-index: 1000;
  flex-shrink: 0;
  order: -1;
}

.topbar,
header.topbar {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}

main {
  flex: 1 0 auto;
  min-height: 0;
  flex-grow: 1;
}

.page-content {
  flex: 1;
  min-height: 0;
}

/* ===== Variables ===== */
:root {
  --dark-brown: #241915;
  --light-hero: #ecf0ef;
  --muted-white: #f6f6f6;
  --accent: #fff;
  --bg-color: #ffffff;
  --text-color: #111111;
  --nav-bg: #f8f8f8;
  --card-bg: #ffffff;
  --footer-bg: #1f140f;
  --footer-text: #fff;
  --link-color: #ccc;
  --overlay-bg: rgba(0,0,0,0.55);
}

/* ===== Dark Mode Variables ===== */
body.dark-mode {
  --bg-color: #0e0e0e;
  --text-color: #f5f5f5;
  --nav-bg: #111111;
  --card-bg: #1b1b1b;
  --footer-bg: #2a1f1a;
  --footer-text: #fff;
  --link-color: #ccc;
  --overlay-bg: rgba(0,0,0,0.7);
  --light-hero: #1a1a1a;
  --muted-white: #2a2a2a;
}

/* ===== Layout Helpers ===== */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 28px;
}

/* ===== Topbar/Header ===== */
.topbar {
  background-color: var(--nav-bg);
  color: var(--accent);
  height: 80px;
  display: flex;
  align-items: center;
  box-shadow: 0 1px 0 rgba(41, 24, 24, 0.15) inset;
  position: sticky;
  top: 0;
  z-index: 1000;
  transition: background-color 0.3s, color 0.3s;
  overflow: hidden;
  width: 100%;
  flex-shrink: 0;
  visibility: visible;
  opacity: 1;
}
.topbar-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  flex-wrap: nowrap;
  overflow: hidden;
  max-width: 100%;
}
.left-group {
  display: flex;
  align-items: center;
  gap: 18px;
  flex: 0 1 auto;
  min-width: 0;
}
.avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  color: #fff;
  font-weight: 600;
  font-size: 22px;
  transition: background-color 0.3s, color 0.3s, border-color 0.3s;
}

body:not(.dark-mode) .avatar {
  background-color: #ff6d2e;
  color: #fff;
  border: 2px solid rgba(0,0,0,0.1);
}

body.dark-mode .avatar {
  background-color: #ff6d2e;
  color: #fff;
  border: 2px solid rgba(0,0,0,0.1);
}
.divider {
  width: 2px;
  height: 36px;
  background: rgba(255,255,255,0.06);
  transition: background-color 0.3s;
}

body:not(.dark-mode) .divider {
  background: rgba(0,0,0,0.1);
}

body.dark-mode .divider {
  background: rgba(255, 109, 46, 0.2);
}
.main-nav {
  display: flex;
  gap: 28px;
  align-items: center;
  flex-wrap: nowrap;
}
.main-nav .nav-item {
  color: var(--text-color);
  text-decoration: none;
  font-weight: 700;
  letter-spacing: 0.2px;
  padding: 8px 4px;
  font-size: 16px;
  transition: color 0.3s;
}
.main-nav .nav-item:hover {
  text-decoration: underline;
}
.right-group {
  display: flex;
  align-items: center;
  gap: 18px;
  flex: 0 0 auto;
  flex-shrink: 0;
  min-width: 0;
}
.icon-btn {
  background: transparent;
  border: none;
  color: var(--text-color);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.15s, transform 0.06s;
  position: relative;
}
.icon-btn:hover {
  background: rgba(255,255,255,0.04);
  transform: translateY(-1px);
}
.icon-btn svg {
  display: block;
  stroke: currentColor;
}

.cart-count,
.wishlist-count {
  position: absolute;
  top: -6px;
  right: -6px;
  background-color: red;
  color: white;
  font-size: 11px;
  border-radius: 50%;
  padding: 2px 6px;
  min-width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  line-height: 1;
  z-index: 1;
}

/* ===== Login Dropdown ===== */
.login-dropdown-container {
  position: relative;
}
.login-dropdown-btn {
  background: transparent;
  border: none;
  color: var(--text-color);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.15s, transform 0.06s;
}
.login-dropdown-btn:hover {
  background: rgba(255,255,255,0.04);
  transform: translateY(-1px);
}
.login-dropdown-btn svg {
  display: block;
  stroke: currentColor;
}
.login-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: var(--card-bg, #fff);
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 280px;
  z-index: 1000;
  overflow: hidden;
}
.login-dropdown.active {
  display: block;
}
body.dark-mode .login-dropdown {
  border-color: rgba(255,255,255,0.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.dropdown-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  color: var(--text-color);
  font-size: 14px;
  font-weight: 500;
}
body.dark-mode .dropdown-header {
  border-bottom-color: rgba(255,255,255,0.1);
}
.dropdown-header svg {
  stroke: #9333ea;
  fill: none;
}
.dropdown-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  border-bottom: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode .dropdown-profile {
  border-bottom-color: rgba(255,255,255,0.1);
}
.profile-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-color, #f5f5f5);
  color: var(--text-color);
  flex-shrink: 0;
}
body.dark-mode .profile-avatar {
  border-color: rgba(255,255,255,0.1);
  background: rgba(255,255,255,0.05);
}
.profile-info {
  flex: 1;
  min-width: 0;
}
.profile-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 4px;
}
.profile-phone {
  font-size: 14px;
  color: var(--text-color);
  opacity: 0.7;
}
.dropdown-divider {
  height: 1px;
  background: rgba(0,0,0,0.1);
  margin: 0;
}
body.dark-mode .dropdown-divider {
  background: rgba(255,255,255,0.1);
}
.dropdown-menu {
  padding: 8px 0;
}
.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  color: var(--text-color);
  text-decoration: none;
  cursor: pointer;
  transition: background-color 0.2s;
  position: relative;
}
.dropdown-item:hover {
  background-color: var(--muted-white, #f5f5f5);
}
body.dark-mode .dropdown-item:hover {
  background-color: rgba(255,255,255,0.05);
}
.dropdown-item svg:first-child {
  flex-shrink: 0;
  stroke: currentColor;
}
.dropdown-item span {
  flex: 1;
  font-size: 14px;
}
.item-indicator {
  position: absolute;
  left: 18px;
  bottom: 10px;
  stroke: #9333ea;
  fill: none;
  width: 10px;
  height: 10px;
}

/* ===== Dark Mode Toggle Switch ===== */
.dark-mode-toggle-container {
  display: flex;
  align-items: center;
  margin: 0 4px;
}

.dark-mode-toggle {
  position: relative;
  display: inline-block;
  width: 70px;
  height: 32px;
  cursor: pointer;
}

.toggle-input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-track {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #e0e0e0;
  border-radius: 16px;
  transition: 0.3s;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

body.dark-mode .toggle-track {
  background-color: #1a1a1a;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.toggle-indicator {
  position: absolute;
  height: 24px;
  width: 30px;
  left: 4px;
  top: 50%;
  transform: translateY(-50%);
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  transition: 0.3s ease;
  z-index: 1;
}

body.dark-mode .toggle-indicator {
  background-color: rgba(255, 255, 255, 0.2);
}

.sun-icon,
.moon-icon {
  position: relative;
  width: 18px;
  height: 18px;
  stroke: #333;
  fill: none;
  z-index: 2;
  transition: opacity 0.3s, stroke 0.3s;
}

body.dark-mode .sun-icon,
body.dark-mode .moon-icon {
  stroke: #fff;
}

.sun-icon {
  opacity: 1;
}

.moon-icon {
  opacity: 0.6;
}

.toggle-input:checked + .toggle-track .toggle-indicator {
  transform: translateY(-50%) translateX(34px);
}

.toggle-input:checked + .toggle-track .sun-icon {
  opacity: 0.6;
}

.toggle-input:checked + .toggle-track .moon-icon {
  opacity: 1;
}

.toggle-input:not(:checked) + .toggle-track .sun-icon {
  opacity: 1;
}

.toggle-input:not(:checked) + .toggle-track .moon-icon {
  opacity: 0.6;
}

.dark-mode-toggle:hover .toggle-track {
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
}

body.dark-mode .dark-mode-toggle:hover .toggle-track {
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
}

/* ===== Profile Sidebar Menu ===== */
.profile-sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.profile-sidebar-overlay.active {
  opacity: 1;
  visibility: visible;
}

.profile-sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 320px;
  max-width: 85vw;
  height: 100vh;
  background: #ffffff;
  z-index: 9999;
  transform: translateX(100%);
  transition: transform 0.3s ease;
  box-shadow: -2px 0 12px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

body.dark-mode .profile-sidebar {
  background: #1b1b1b;
  box-shadow: -2px 0 12px rgba(0, 0, 0, 0.4);
}

.profile-sidebar.active {
  transform: translateX(0);
}

.profile-sidebar-header {
  padding: 16px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: flex-end;
  align-items: center;
  position: sticky;
  top: 0;
  background: inherit;
  z-index: 1;
}

body.dark-mode .profile-sidebar-header {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

.profile-sidebar-close {
  background: transparent;
  border: none;
  color: var(--text-color, #333);
  cursor: pointer;
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.profile-sidebar-close:hover {
  background: rgba(0, 0, 0, 0.05);
}

body.dark-mode .profile-sidebar-close:hover {
  background: rgba(255, 255, 255, 0.05);
}

.profile-sidebar-close svg {
  stroke: currentColor;
}

.profile-sidebar-content {
  flex: 1;
  padding: 0;
}

.profile-sidebar-user {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 24px 20px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

body.dark-mode .profile-sidebar-user {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

.profile-sidebar-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--muted-white, #f5f5f5);
  color: var(--text-color);
  flex-shrink: 0;
}

body.dark-mode .profile-sidebar-avatar {
  border-color: rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
}

.profile-sidebar-avatar svg {
  stroke: currentColor;
}

.profile-sidebar-info {
  flex: 1;
  min-width: 0;
}

.profile-sidebar-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-color, #333);
  margin-bottom: 4px;
}

.profile-sidebar-phone {
  font-size: 14px;
  color: var(--text-color, #666);
  opacity: 0.7;
}

.profile-sidebar-menu {
  padding: 8px 0;
}

.profile-sidebar-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  color: var(--text-color, #333);
  text-decoration: none;
  cursor: pointer;
  transition: background-color 0.2s;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  font-size: 16px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  position: relative;
}

.profile-sidebar-item:last-of-type {
  border-bottom: none;
}

.profile-sidebar-item:hover {
  background-color: rgba(0, 0, 0, 0.03);
}

.profile-sidebar-item.active {
  background-color: #f5f5f5 !important;
  font-weight: 600;
}

body.dark-mode .profile-sidebar-item {
  border-bottom-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode .profile-sidebar-item:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

body.dark-mode .profile-sidebar-item.active {
  background-color: rgba(255, 255, 255, 0.1) !important;
}

.profile-sidebar-item svg {
  flex-shrink: 0;
  stroke: currentColor;
}

.profile-sidebar-item span {
  flex: 1;
  font-size: 16px;
  font-weight: 500;
}

/* ===== Footer ===== */
.site-footer {
  background-color: var(--footer-bg);
  color: var(--footer-text);
  padding: 24px 0 12px;
  margin-top: auto !important;
  flex-shrink: 0 !important;
  width: 100% !important;
  position: relative;
  z-index: 1;
  clear: both;
}

.page-wrapper {
  display: flex !important;
  flex-direction: column !important;
  min-height: 100vh;
}

.page-wrapper > .site-footer,
.page-wrapper > #footer-placeholder {
  margin-top: auto !important;
  order: 999 !important;
  width: 100% !important;
  flex-shrink: 0 !important;
}

#footer-placeholder {
  margin-top: auto !important;
  flex-shrink: 0 !important;
  width: 100% !important;
  order: 999 !important;
  display: block !important;
  clear: both;
  min-height: 0;
}

#footer-placeholder > .site-footer {
  margin-top: 0;
}

.page-wrapper > main {
  flex: 1 0 auto !important;
  min-height: 0;
}

body > .page-wrapper > #footer-placeholder,
body > .page-wrapper > .site-footer {
  margin-top: auto;
}
.footer-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 20px;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 28px;
}
.footer-column {
  flex: 1 1 160px;
}
.footer-avatar {
  width: 42px;
  height: 42px;
  background-color: #ff6d2e;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 16px;
  color: #fff;
  margin-bottom: 10px;
}
.address, .phone {
  font-size: 11px;
  line-height: 1.4;
  color: var(--footer-text);
  margin-bottom: 10px;
}
.address p, .phone p {
  margin: 3px 0;
}
.address p strong, .phone p strong {
  font-size: 11px;
  font-weight: 600;
}
.phone a {
  color: var(--footer-text);
  text-decoration: none;
  font-weight: 500;
  font-size: 11px;
}
.smartbiz-logo {
  height: 24px;
  width: auto;
  vertical-align: middle;
}

.footer-column h4 {
  font-size: 12px;
  margin-bottom: 8px;
  color: var(--footer-text);
  font-weight: 600;
}
.footer-column ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.footer-column ul li {
  margin-bottom: 5px;
}
.footer-column ul li a {
  color: var(--link-color);
  text-decoration: none;
  font-size: 11px;
  transition: color 0.3s;
}
.footer-column ul li a:hover {
  color: var(--footer-text);
  text-decoration: underline;
}
.footer-bottom {
  margin-top: 20px;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  font-size: 11px;
  color: var(--link-color);
  align-items: center;
  gap: 16px;
  width: 100%;
}

.footer-bottom .container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 28px;
}

.footer-bottom .payment-info,
.footer-bottom .powered-by {
  display: flex;
  align-items: center;
  gap: 5px;
}
.footer-bottom .icon {
  font-size: 14px;
}

/* ===== Mobile Menu ===== */
.mobile-menu-btn {
  display: none !important;
}

.mobile-nav {
  display: none !important;
}

@media (max-width: 880px) {
  .main-nav {
    gap: 14px;
  }
  .main-nav .nav-item {
    font-size: 13.5px;
    padding: 6px 2px;
  }
  .avatar { 
    width: 52px; 
    height: 52px; 
    font-size: 18px; 
  }
  .divider {
    height: 32px;
  }
  .topbar { 
    height: 68px; 
  }
  .topbar-inner {
    padding: 0 16px;
  }
  .right-group {
    gap: 10px;
    flex-shrink: 0;
  }
  .icon-btn {
    padding: 6px;
    flex-shrink: 0;
  }
  .icon-btn svg {
    width: 16px;
    height: 16px;
  }
  .dark-mode-toggle {
    width: 56px;
    height: 28px;
    flex-shrink: 0;
  }
  .dark-mode-toggle-container {
    flex-shrink: 0;
  }
}

@media (max-width: 768px) {
  .container {
    padding: 0 16px;
  }
  .topbar {
    height: 64px;
  }
  .topbar-inner {
    padding: 0 12px;
  }
  .avatar {
    width: 48px;
    height: 48px;
    font-size: 16px;
  }
  .divider {
    height: 28px;
  }
  .left-group {
    gap: 12px;
  }
  .main-nav {
    gap: 12px;
  }
  .main-nav .nav-item {
    font-size: 13px;
    padding: 5px 1px;
  }
  .right-group {
    gap: 8px;
  }
  .icon-btn {
    padding: 5px;
  }
  .icon-btn svg {
    width: 15px;
    height: 15px;
  }
  .dark-mode-toggle {
    width: 52px;
    height: 26px;
  }
  .site-footer {
    padding: 20px 0 12px;
  }
  .footer-container {
    flex-direction: column;
    gap: 24px;
    padding: 0 20px;
  }
  .footer-column {
    flex: 1 1 100%;
    text-align: left;
  }
  .footer-column.contact-info {
    text-align: left;
  }
  .footer-bottom {
    flex-direction: column;
    text-align: center;
    gap: 12px;
    padding: 0 20px;
  }
  .footer-bottom .container {
    flex-direction: column;
    padding: 0;
    gap: 12px;
  }
  .profile-sidebar {
    width: 280px;
    max-width: 90vw;
  }
  .profile-sidebar-user {
    padding: 20px 16px;
  }
  .profile-sidebar-avatar {
    width: 44px;
    height: 44px;
  }
  .profile-sidebar-name {
    font-size: 15px;
  }
  .profile-sidebar-item {
    padding: 14px 16px;
    font-size: 15px;
  }
}

@media (max-width: 480px) {
  .topbar {
    height: 60px;
  }
  .topbar-inner {
    padding: 0 10px;
  }
  .avatar { 
    width: 44px; 
    height: 44px; 
    font-size: 14px; 
  }
  .divider {
    height: 24px;
    width: 1.5px;
  }
  .left-group {
    gap: 10px;
  }
  .main-nav {
    gap: 10px;
  }
  .main-nav .nav-item {
    font-size: 12px;
    padding: 4px 1px;
  }
  .right-group {
    gap: 6px;
  }
  .icon-btn {
    padding: 4px;
  }
  .icon-btn svg {
    width: 14px;
    height: 14px;
  }
  .cart-count {
    font-size: 9px;
    min-width: 16px;
    height: 16px;
    padding: 1px 4px;
    top: -4px;
    right: -4px;
  }
  .dark-mode-toggle {
    width: 48px;
    height: 24px;
  }
  .site-footer {
    padding: 20px 0 10px;
  }
  .footer-container { 
    flex-direction: column; 
    gap: 16px;
    padding: 0 16px;
  }
  .footer-column { 
    width: 100%; 
    margin-bottom: 0;
  }
  .footer-avatar {
    width: 40px;
    height: 40px;
    font-size: 14px;
    margin-bottom: 8px;
  }
  .address, .phone {
    font-size: 10px;
    margin-bottom: 8px;
  }
  .address p strong, .phone p strong {
    font-size: 10px;
  }
  .footer-column h4 {
    font-size: 11px;
    margin-bottom: 6px;
  }
  .footer-column ul li {
    margin-bottom: 4px;
  }
  .footer-column ul li a {
    font-size: 10px;
  }
  .footer-bottom { 
    flex-direction: column; 
    gap: 8px; 
    text-align: center;
    margin-top: 16px;
    padding-top: 12px;
    font-size: 10px;
    padding: 0 16px;
  }
  .footer-bottom .payment-info,
  .footer-bottom .powered-by {
    justify-content: center;
  }
  .smartbiz-logo {
    height: 20px;
  }
  .right-group {
    gap: 8px;
  }
  .dark-mode-toggle {
    width: 55px;
    height: 26px;
  }
}

/* ===== Login Page Specific Styles ===== */
    .login-container {
      max-width: 400px;
      width: 90%;
      margin: 80px auto;
      background: var(--card-bg, #f8f8f8);
      padding: 40px 30px;
      border-radius: 12px;
      text-align: center;
      transition: background-color 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
      .login-container {
        margin: 60px auto;
        padding: 30px 24px;
      }
    }
    
    @media (max-width: 480px) {
      .login-container {
        margin: 40px auto;
        padding: 24px 20px;
        width: 95%;
      }
    }
    .login-container h1 { 
      margin-bottom: 20px;
      color: var(--text-color, #333);
      transition: color 0.3s;
    }
    .login-container input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 8px;
      background: var(--bg-color, #fff);
      color: var(--text-color, #333);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    body.dark-mode .login-container input {
      border-color: rgba(255,255,255,0.2);
    }
    .login-container button {
      width: 95%;
      background: #000;
      color: #fff;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-container button:hover { background: #333; }
  </style>
</head>
<body>
  <div class="page-wrapper">
  <header class="topbar">
    <div class="topbar-inner container">
      <div class="left-group">
        <div class="avatar" aria-hidden="true">
          <a href="../index.html" style="text-decoration:none;color:inherit;display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><span>V</span></a>
        </div>
        <div class="divider"></div>
          <nav class="main-nav" aria-label="Main">
            <a href="categories.html" class="nav-item">Categories</a>
            <a href="featured.html" class="nav-item">Featured</a>
            <a href="products.html" class="nav-item">Products</a>
          </nav>
          <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle Menu">☰</button>
        </div>
      <div class="right-group">
        <!-- Dark Mode Toggle Switch -->
        <div class="dark-mode-toggle-container">
          <label class="dark-mode-toggle" for="dark-mode-switch" title="Toggle Dark Mode">
            <input type="checkbox" id="dark-mode-switch" class="toggle-input">
            <span class="toggle-track">
              <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="4"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
              <span class="toggle-indicator"></span>
            </span>
          </label>
        </div>

        <button class="icon-btn" id="searchBtn" title="Search Products">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="6" stroke-width="1.6"></circle>
            <path d="M21 21l-4.35-4.35" stroke-width="1.6" stroke-linecap="round"></path>
          </svg>
        </button>

        <button class="icon-btn" id="wishlistBtn" title="Wishlist" onclick="window.location.href='wishlist.html'">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke-width="1.5" stroke-linejoin="round"></path>
          </svg>
          <span class="wishlist-count" id="wishlistCount">0</span>
        </button>
        <button class="icon-btn" id="cartBtn" title="Cart" onclick="window.location.href='cart.html'">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor">
            <path d="M6 6h15l-1.5 9h-12z" stroke-width="1.5" stroke-linejoin="round"></path>
            <circle cx="10" cy="20" r="1.4" stroke-width="1.5"></circle>
            <circle cx="18" cy="20" r="1.4" stroke-width="1.5"></circle>
          </svg>
          <span class="cart-count" id="cartCount">0</span>
        </button>
        <button class="icon-btn" id="locationBtn" title="Locations">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
            <path d="M12 21s8-5.5 8-11a8 8 0 1 0-16 0c0 5.5 8 11 8 11z" stroke-width="1.6"></path>
            <circle cx="12" cy="10" r="2.2" stroke-width="1.6"></circle>
          </svg>
        </button>

        <!-- Login Dropdown -->
        <div class="login-dropdown-container">
          <button class="icon-btn login-dropdown-btn" id="loginDropdownBtn" title="User Menu">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </button>
          <div class="login-dropdown" id="loginDropdown">
            <div class="dropdown-header">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              <span>User...</span>
            </div>
            <div class="dropdown-profile">
              <div class="profile-avatar">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </div>
              <div class="profile-info">
                <div class="profile-name">Hello User</div>
                <div class="profile-phone">+1234567890</div>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item" id="myOrdersBtn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <span>My Orders</span>
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" class="item-indicator">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                  <path d="M2 17l10 5 10-5"></path>
                  <path d="M2 12l10 5 10-5"></path>
                </svg>
              </a>
              <div class="dropdown-item" id="lightModeBtn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
                  <circle cx="8" cy="12" r="3"></circle>
                </svg>
                <span id="lightModeText">Light Mode</span>
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" class="item-indicator">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                  <path d="M2 17l10 5 10-5"></path>
                  <path d="M2 12l10 5 10-5"></path>
                </svg>
              </div>
              <a href="login.html" class="dropdown-item" id="signOutBtn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Sign Out</span>
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" class="item-indicator">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                  <path d="M2 17l10 5 10-5"></path>
                  <path d="M2 12l10 5 10-5"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Profile Sidebar Menu -->
  <div class="profile-sidebar-overlay" id="profileSidebarOverlay"></div>
  <div class="profile-sidebar" id="profileSidebar">
    <div class="profile-sidebar-header">
      <button class="profile-sidebar-close" id="profileSidebarClose" aria-label="Close Menu">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="profile-sidebar-content">
      <div class="profile-sidebar-user">
        <div class="profile-sidebar-avatar">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="profile-sidebar-info">
          <div class="profile-sidebar-name" id="profileName">Hello User</div>
          <div class="profile-sidebar-phone" id="profilePhone">+1234567890</div>
        </div>
      </div>
      <div class="profile-sidebar-menu">
        <a href="cart.html" class="profile-sidebar-item" id="sidebarMyOrders">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <span>My Orders</span>
        </a>
        <div class="profile-sidebar-item" id="sidebarLightMode">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
            <circle cx="8" cy="12" r="3"></circle>
          </svg>
          <span id="sidebarLightModeText">Light Mode</span>
        </div>
        <div class="profile-sidebar-item" id="sidebarSignOut" onclick="handleSignOut()" style="cursor: pointer;">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span>Sign Out</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div class="search-modal" id="searchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="search-modal-content" style="background: var(--card-bg, #fff); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); position: relative;">
      <h3 style="margin-bottom: 20px; color: var(--text-color, #333); font-size: 1.5rem;">Search Products</h3>
      <div style="position: relative; margin-bottom: 20px;">
        <input type="text" class="search-input" id="searchInput" placeholder="Search for products..." autocomplete="off" style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 1rem; background: var(--bg-color, #fff); color: var(--text-color, #333); transition: border-color 0.3s;">
        <button class="search-close" id="searchClose" style="position: absolute; top: 50%; right: 12px; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color, #666); padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">&times;</button>
      </div>
      <div class="search-results" id="searchResults" style="max-height: 400px; overflow-y: auto;">
        <!-- Search results will appear here -->
      </div>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <nav class="mobile-nav" id="mobileNav">
    <a href="categories.html" class="nav-item">Categories</a>
    <a href="featured.html" class="nav-item">Featured</a>
    <a href="products.html" class="nav-item">Products</a>
    <a href="cart.html" class="nav-item">Cart</a>
    <a href="login.html" class="nav-item active">Login</a>
  </nav>

  <main style="flex: 1; display: flex; align-items: center;">
    <div class="login-container">
      <h1 id="loginTitle">Welcome Back</h1>
      <div id="loginFormContainer">
        <form id="loginForm">
          <input type="tel" id="loginPhone" placeholder="Phone Number" required pattern="[0-9]{10}" maxlength="10">
          <button type="submit" id="sendOtpBtn">Send OTP</button>
          <p style="margin-top:10px; font-size: 0.9rem; color: var(--text-color, #666);">We'll send you a 6-digit OTP to verify your number</p>
          <p style="margin-top:10px;">New user? <a href="#" onclick="event.preventDefault(); showRegisterForm();">Create an account</a></p>
        </form>
      </div>
      
      <!-- OTP Verification Form (hidden by default) -->
      <div id="otpFormContainer" style="display: none;">
        <form id="otpForm">
          <p style="margin-bottom: 20px; color: var(--text-color, #666);">Enter the 6-digit OTP sent to <strong id="otpPhoneDisplay"></strong></p>
          <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 20px;">
            <input type="text" id="otp1" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="otp2" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="otp3" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="otp4" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="otp5" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="otp6" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
          </div>
          <button type="submit" id="verifyOtpBtn">Verify OTP</button>
          <p style="margin-top:10px; font-size: 0.9rem;">
            Didn't receive OTP? <a href="#" onclick="event.preventDefault(); resendOtp();" id="resendOtpLink" style="color: #ff6d2e;">Resend</a>
            <span id="resendTimer" style="display: none; margin-left: 8px;"></span>
          </p>
          <p style="margin-top:10px;"><a href="#" onclick="event.preventDefault(); backToPhoneInput();">Change Phone Number</a></p>
        </form>
      </div>
      
      <!-- Register Form (hidden by default) -->
      <div id="registerFormContainer" style="display: none;">
        <form id="registerForm">
          <input type="text" id="registerName" placeholder="Full Name" required>
          <input type="tel" id="registerPhone" placeholder="Phone Number" required pattern="[0-9]{10}" maxlength="10">
          <button type="submit" id="registerSendOtpBtn">Send OTP</button>
          <p style="margin-top:10px; font-size: 0.9rem;">We'll send you a 6-digit OTP to verify your number</p>
          <p style="margin-top:10px;">Already have an account? <a href="#" onclick="event.preventDefault(); showLoginForm();">Login</a></p>
        </form>
      </div>
      
      <!-- Register OTP Verification Form (hidden by default) -->
      <div id="registerOtpFormContainer" style="display: none;">
        <form id="registerOtpForm">
          <p style="margin-bottom: 20px;">Enter the 6-digit OTP sent to <strong id="registerOtpPhoneDisplay"></strong></p>
          <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 20px;">
            <input type="text" id="registerOtp1" class="register-otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="registerOtp2" class="register-otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="registerOtp3" class="register-otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="registerOtp4" class="register-otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="registerOtp5" class="register-otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
            <input type="text" id="registerOtp6" class="register-otp-input" maxlength="1" pattern="[0-9]" required autocomplete="off" style="width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; background: var(--bg-color, #fff); color: var(--text-color, #333);">
          </div>
          <button type="submit" id="registerVerifyOtpBtn">Verify OTP & Create Account</button>
          <p style="margin-top:10px; font-size: 0.9rem;">
            Didn't receive OTP? <a href="#" onclick="event.preventDefault(); resendRegisterOtp();" id="resendRegisterOtpLink" style="color: #ff6d2e;">Resend</a>
            <span id="resendRegisterTimer" style="display: none; margin-left: 8px;"></span>
          </p>
          <p style="margin-top:10px;"><a href="#" onclick="event.preventDefault(); backToRegisterPhoneInput();">Change Phone Number</a></p>
        </form>
      </div>
      
      <!-- Forgot Password Form (hidden by default) -->
      <div id="forgotPasswordContainer" style="display: none;">
        <form id="forgotPasswordForm">
          <p style="margin-bottom: 20px; color: var(--text-color, #666);">Enter your email to reset password</p>
          <input type="email" id="forgotEmail" placeholder="Email address" required>
          <button type="submit">Send Reset Link</button>
          <p style="margin-top:10px;"><a href="#" onclick="event.preventDefault(); showLoginForm();">Back to Login</a></p>
        </form>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-container container">
      <div class="footer-column contact-info">
        <div class="footer-avatar">V</div>
        <div class="address">
          <p><strong>Shraddha Garden, Gawade Colony</strong></p>
          <p>Chinchwad, Maharashtra, 411019</p>
        </div>
        <div class="phone">
          <p><strong>Talk to us</strong></p>
          <p><a href="tel:+917588933972">+91 7588933972</a></p>
        </div>
      </div>

      <div class="footer-column">
        <h4>Help</h4>
        <ul>
          <li><a href="#">Store policies</a></li>
          <li><a href="#">Track your Orders</a></li>
          <li><a href="#">Return Policy</a></li>
          <li><a href="#">Privacy Policy</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h4>Shop</h4>
        <ul>
          <li><a href="#">Mens all wear</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom container">
      <div class="payment-info">
        <span>We accept</span>
        <span class="icon">&#128179;</span>
        <span>Cash on Delivery</span>
      </div>
      <div class="powered-by">
        <span>Built with</span>
        <img src="../assets/SmartBiz.png" alt="Smartbiz by Sakhi" class="smartbiz-logo" />
      </div>
    </div>
  </footer>
  </div>
  <!-- API Configuration and Integration -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/app.js"></script>
  <script>
    // ====== API CONFIGURATION ======
    // Auto-detect backend URL based on current host
    // If frontend is on 192.168.1.25:3000, backend should be on 192.168.1.25:8080
    const getBackendUrl = () => {
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      
      // If running on localhost/127.0.0.1, use localhost for backend
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:8080/api';
      }
      
      // Otherwise, use the same hostname with port 8080
      return `${protocol}//${hostname}:8080/api`;
    };
    
    const API_BASE = getBackendUrl();
    console.log('API Base URL:', API_BASE);
    
    // API Helper Functions with better error handling
    async function apiCall(endpoint, method = 'GET', body = null) {
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('currentUser') ? 
        JSON.parse(localStorage.getItem('currentUser')).token : null;
      if (token) headers['Authorization'] = `Bearer ${token}`;
      
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, options);
        
        // Handle non-OK responses
        if (!response.ok) {
          let errorMessage = `HTTP error! status: ${response.status}`;
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorData.error || errorMessage;
          } catch (e) {
            // If response is not JSON, use status text
            errorMessage = response.statusText || errorMessage;
          }
          throw new Error(errorMessage);
        }
        
        return await response.json();
      } catch (error) {
        // Handle network errors
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          const backendUrl = API_BASE.replace('/api', '');
          throw new Error(
            'Cannot connect to backend server. Please ensure:\n' +
            `1. Backend server is running on ${backendUrl}\n` +
            '2. CORS is properly configured for your frontend origin\n' +
            '3. No firewall is blocking the connection'
          );
        }
        console.error('API Error:', error);
        throw error;
      }
    }
    
    // ====== USER AUTHENTICATION API ======
    const UserAPI = {
      sendOtp: async (phone) => {
        return apiCall('/user/send-otp', 'POST', { phone });
      },
      verifyOtp: async (phone, code) => {
        return apiCall('/user/verify-otp', 'POST', { phone, code });
      }
    };
    
    // Search functionality
    const searchBtn = document.getElementById('searchBtn');
    const searchModal = document.getElementById('searchModal');
    const searchInput = document.getElementById('searchInput');
    const searchClose = document.getElementById('searchClose');
    const searchResults = document.getElementById('searchResults');

    // Product data for search
    const allProducts = [
      { name: 'Colourblocked Polo T-shirt', price: 593, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Pure Cotton Custom Fit Shirt', price: 917, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Polo Collar Slim Fit T-shirt', price: 929, img: 'products.html', brand: 'Louis Philippe Jeans' },
      { name: 'Pure Cotton Casual Shirt', price: 993, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Classic Fit Formal Shirt', price: 849, img: 'products.html', brand: 'Louis Philippe Jeans' },
      { name: 'Regular Fit Cotton T-shirt', price: 699, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Slim Fit Cotton Shirt', price: 799, img: 'products.html', brand: 'Louis Philippe Jeans' },
      { name: 'Oversized Graphic Tee', price: 499, img: 'featured.html', brand: 'V Store' },
      { name: 'Minimalist Hoodie', price: 799, img: 'featured.html', brand: 'V Store' },
      { name: 'Baggy Fit Jeans', price: 999, img: 'featured.html', brand: 'V Store' },
      { name: 'Co-ord Set', price: 1199, img: 'featured.html', brand: 'V Store' }
    ];

    function performSearch(query) {
      const lowerQuery = query.toLowerCase().trim();
      if (lowerQuery === '') {
        searchResults.innerHTML = '';
        return;
      }

      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(lowerQuery) ||
        p.brand.toLowerCase().includes(lowerQuery)
      );

      searchResults.innerHTML = '';
      
      if (filtered.length === 0) {
        searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-color, #666);">No products found</div>';
        return;
      }

      filtered.forEach(product => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px;';
        item.innerHTML = `
          <div style="flex: 1;">
            <h4 style="margin: 0 0 4px 0; color: var(--text-color, #333); font-size: 1rem;">${product.name}</h4>
            <p style="margin: 0; color: #e53935; font-weight: 600; font-size: 0.9rem;">₹${product.price}</p>
            <p style="margin: 4px 0 0 0; color: var(--text-color, #666); font-size: 0.85rem;">${product.brand}</p>
          </div>
        `;
        item.addEventListener('mouseenter', () => {
          item.style.background = 'var(--muted-white, #f5f5f5)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.background = 'transparent';
        });
        item.addEventListener('click', () => {
          window.location.href = product.img;
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        });
        searchResults.appendChild(item);
      });
    }

    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        searchModal.style.display = 'flex';
        setTimeout(() => searchInput.focus(), 100);
      });
    }

    if (searchClose) {
      searchClose.addEventListener('click', () => {
        searchModal.style.display = 'none';
        searchInput.value = '';
        searchResults.innerHTML = '';
      });
    }

    if (searchModal) {
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        }
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        performSearch(e.target.value);
      });
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        }
      });
    }

    // Mobile Menu Toggle
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mobileNav = document.getElementById("mobileNav");
    if (mobileMenuBtn && mobileNav) {
      mobileMenuBtn.addEventListener("click", () => {
        mobileNav.classList.toggle("active");
      });
      document.addEventListener("click", (e) => {
        if (!mobileMenuBtn.contains(e.target) && !mobileNav.contains(e.target)) {
          mobileNav.classList.remove("active");
        }
      });
      mobileNav.querySelectorAll(".nav-item").forEach(item => {
        item.addEventListener("click", () => {
          mobileNav.classList.remove("active");
        });
      });
    }

    // Profile Sidebar Toggle
    const profileSidebar = document.getElementById('profileSidebar');
    const profileSidebarOverlay = document.getElementById('profileSidebarOverlay');
    const profileSidebarClose = document.getElementById('profileSidebarClose');
    const loginDropdownBtn = document.getElementById('loginDropdownBtn');
    const loginDropdown = document.getElementById('loginDropdown');
    const lightModeBtn = document.getElementById('lightModeBtn');
    const sidebarLightModeBtn = document.getElementById('sidebarLightMode');

    function openProfileSidebar() {
      if (profileSidebar) {
        profileSidebar.classList.add('active');
        if (profileSidebarOverlay) {
          profileSidebarOverlay.classList.add('active');
        }
        document.body.style.overflow = 'hidden';
      }
    }

    function closeProfileSidebar() {
      if (profileSidebar) {
        profileSidebar.classList.remove('active');
        if (profileSidebarOverlay) {
          profileSidebarOverlay.classList.remove('active');
        }
        document.body.style.overflow = '';
      }
    }

    // Profile button is handled by onclick="openProfileSidebar()" in HTML

    // Close sidebar
    if (profileSidebarClose) {
      profileSidebarClose.addEventListener('click', () => {
        closeProfileSidebar();
      });
    }

    // Close sidebar when clicking overlay
    if (profileSidebarOverlay) {
      profileSidebarOverlay.addEventListener('click', () => {
        closeProfileSidebar();
      });
    }

    // Close sidebar on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && profileSidebar && profileSidebar.classList.contains('active')) {
        closeProfileSidebar();
      }
    });

    // Light Mode toggle from sidebar
    if (sidebarLightModeBtn) {
      sidebarLightModeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const darkModeSwitch = document.getElementById('dark-mode-switch');
        if (darkModeSwitch) {
          darkModeSwitch.checked = !darkModeSwitch.checked;
          darkModeSwitch.dispatchEvent(new Event('change'));
        }
      });
    }

    // Light Mode toggle from dropdown (if exists)
    if (lightModeBtn) {
      lightModeBtn.addEventListener('click', () => {
        const darkModeSwitch = document.getElementById('dark-mode-switch');
        if (darkModeSwitch) {
          darkModeSwitch.checked = !darkModeSwitch.checked;
          darkModeSwitch.dispatchEvent(new Event('change'));
        }
      });
    }

    // Update Light Mode text based on current theme (optimized)
    function updateLightModeText() {
      // Cache DOM queries to avoid repeated lookups
      const lightModeText = document.getElementById('lightModeText');
      const sidebarLightModeText = document.getElementById('sidebarLightModeText');
      
      // Only check theme once
      const isDarkMode = document.body.classList.contains('dark-mode');
      const text = isDarkMode ? 'Light Mode' : 'Dark Mode';
      
      // Update both elements if they exist
      if (lightModeText) {
        lightModeText.textContent = text;
      }
      if (sidebarLightModeText) {
        sidebarLightModeText.textContent = text;
      }
    }

    // Theme initialization is handled by app.js
    // We just need to update the light mode text when theme changes
    let textUpdateHandler = null;
    
    function setupLightModeTextUpdate() {
      const darkModeSwitch = document.getElementById('dark-mode-switch');
      if (!darkModeSwitch) {
        // Retry if element not found yet (app.js might still be loading)
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setupLightModeTextUpdate);
        } else {
          setTimeout(setupLightModeTextUpdate, 50);
        }
        return;
      }
      
      // Remove previous handler if exists
      if (textUpdateHandler) {
        darkModeSwitch.removeEventListener('change', textUpdateHandler);
      }
      
      // Add lightweight handler to update text on theme change
      textUpdateHandler = function() {
        // Use requestAnimationFrame for smooth updates
        requestAnimationFrame(updateLightModeText);
      };
      
      darkModeSwitch.addEventListener('change', textUpdateHandler);
      
      // Initial update
      updateLightModeText();
    }

    // Setup after app.js initializes (it runs on DOMContentLoaded)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Wait for app.js to initialize theme first
        setTimeout(setupLightModeTextUpdate, 150);
      });
    } else {
      // DOM already loaded, wait for app.js
      setTimeout(setupLightModeTextUpdate, 150);
    }

    // Close sidebar when clicking menu items (except light mode toggle)
    const sidebarMenuItems = document.querySelectorAll('.profile-sidebar-item');
    sidebarMenuItems.forEach(item => {
      if (item.id !== 'sidebarLightMode') {
        item.addEventListener('click', () => {
          setTimeout(() => {
            closeProfileSidebar();
          }, 100);
        });
      }
    });

    // ====== USER AUTHENTICATION SYSTEM ======
    function getCurrentUser() {
      const userStr = localStorage.getItem('currentUser');
      if (userStr) {
        try {
          return JSON.parse(userStr);
        } catch (e) {
          return null;
        }
      }
      return null;
    }

    function setCurrentUser(user) {
      localStorage.setItem('currentUser', JSON.stringify(user));
      localStorage.setItem('rememberUser', 'true');
      updateUserUI();
    }

    function updateUserUI() {
      const user = getCurrentUser();
      if (user) {
        const loginDropdown = document.getElementById('loginDropdown');
        if (loginDropdown) {
          const header = loginDropdown.querySelector('.dropdown-header span');
          if (header) header.textContent = user.name || user.phone;
        }
      }
    }

    // OTP Storage variables
    let otpPhoneNumber = null;
    let resendTimerInterval = null;
    let registerOtpPhoneNumber = null;
    let registerResendTimerInterval = null;

    // Send OTP - Backend API Integration
    async function sendOTP(phone) {
      try {
        const response = await UserAPI.sendOtp(phone);
        
        // Store phone for verification
        otpPhoneNumber = phone;
        localStorage.setItem('pendingPhone', phone);
        
        // Backend returns: { message: "OTP sent successfully", otp: "123456" }
        // Show OTP in console for testing (backend returns it in dev mode)
        if (response.otp) {
          console.log('OTP sent to', phone, ':', response.otp);
        }
        
        // Show success message
        const message = response.otp ? 
          `OTP sent! Your OTP is: ${response.otp}` : 
          response.message || `OTP sent to ${phone}`;
        
        if (window.showToast) {
          showToast(message, 'success', 'OTP Sent');
        } else {
          alert(message);
        }
        
        return true;
      } catch (error) {
        console.error('Failed to send OTP:', error);
        const errorMessage = error.message || 'Failed to send OTP. Please try again.';
        
        // Show error in both toast and alert for network errors
        if (errorMessage.includes('Cannot connect to backend')) {
          alert(errorMessage);
        }
        
        if (window.showToast) {
          showToast(
            errorMessage.includes('Cannot connect') ? 
              'Backend server not reachable. Check console for details.' : 
              errorMessage, 
            'error', 
            'Error'
          );
        } else {
          alert(errorMessage);
        }
        return false;
      }
    }

    // Verify OTP - Backend API Integration
    async function verifyOTP(enteredOtp, phone) {
      try {
        const response = await UserAPI.verifyOtp(phone, enteredOtp);
        
        // Backend returns: {token, userId, fullName, phone}
        if (response.token && response.userId) {
          // Store user data with JWT token
          const user = {
            id: response.userId,
            userId: response.userId,
            name: response.fullName || `User ${phone.slice(-4)}`,
            fullName: response.fullName || `User ${phone.slice(-4)}`,
            phone: response.phone || phone,
            token: response.token
          };
          
          setCurrentUser(user);
          localStorage.removeItem('pendingPhone');
          
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('OTP verification failed:', error);
        const errorMessage = error.message || 'Invalid OTP. Please try again.';
        
        // Show error message
        if (window.showToast) {
          showToast(
            errorMessage.includes('Cannot connect') ? 
              'Backend server not reachable. Check console for details.' : 
              errorMessage, 
            'error', 
            'Verification Failed'
          );
        } else {
          alert(errorMessage);
        }
        
        return false;
      }
    }

    // Start resend timer
    function startResendTimer() {
      let timeLeft = 30; // 30 seconds
      const resendLink = document.getElementById('resendOtpLink');
      const resendTimer = document.getElementById('resendTimer');
      
      if (resendLink) resendLink.style.pointerEvents = 'none';
      if (resendTimer) {
        resendTimer.style.display = 'inline';
        resendTimer.textContent = `(Resend in ${timeLeft}s)`;
      }
      
      if (resendTimerInterval) {
        clearInterval(resendTimerInterval);
      }
      
      resendTimerInterval = setInterval(() => {
        timeLeft--;
        if (resendTimer) {
          resendTimer.textContent = `(Resend in ${timeLeft}s)`;
        }
        
        if (timeLeft <= 0) {
          clearInterval(resendTimerInterval);
          if (resendLink) resendLink.style.pointerEvents = 'auto';
          if (resendTimer) resendTimer.style.display = 'none';
        }
      }, 1000);
    }

    // Setup OTP input navigation
    function setupOtpInputs() {
      const otpInputs = document.querySelectorAll('.otp-input');
      
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          e.target.value = value;
          
          if (value && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
        
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
          pastedData.split('').forEach((char, i) => {
            if (otpInputs[index + i]) {
              otpInputs[index + i].value = char;
            }
          });
          if (pastedData.length === 6) {
            otpInputs[5].focus();
          }
        });
      });
    }

    // Login Form Handler - Send OTP
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const phoneInput = document.getElementById('loginPhone');
        const submitBtn = document.getElementById('sendOtpBtn');
        const phone = phoneInput.value.trim();
        
        // Validate phone number
        if (phone.length !== 10 || !/^[0-9]+$/.test(phone)) {
          if (window.showToast) {
            showToast('Please enter a valid 10-digit phone number', 'error', 'Invalid Phone');
          } else {
            alert('Please enter a valid 10-digit phone number');
          }
          return;
        }
        
        // Show loading state
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        
        try {
          // Send OTP via backend API
          const success = await sendOTP(phone);
          
          if (success) {
            // Hide login form, show OTP form
            document.getElementById('loginFormContainer').style.display = 'none';
            document.getElementById('otpFormContainer').style.display = 'block';
            document.getElementById('otpPhoneDisplay').textContent = phone;
            
            // Focus first OTP input
            setTimeout(() => {
              document.getElementById('otp1').focus();
              setupOtpInputs();
              startResendTimer();
            }, 100);
          }
        } catch (error) {
          console.error('Login error:', error);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // OTP Verification Form Handler
    const otpForm = document.getElementById('otpForm');
    if (otpForm) {
      otpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = otpPhoneNumber || localStorage.getItem('pendingPhone') || document.getElementById('loginPhone').value.trim();
        const otp1 = document.getElementById('otp1').value;
        const otp2 = document.getElementById('otp2').value;
        const otp3 = document.getElementById('otp3').value;
        const otp4 = document.getElementById('otp4').value;
        const otp5 = document.getElementById('otp5').value;
        const otp6 = document.getElementById('otp6').value;
        
        const enteredOtp = otp1 + otp2 + otp3 + otp4 + otp5 + otp6;
        
        if (enteredOtp.length !== 6) {
          if (window.showToast) {
            showToast('Please enter complete 6-digit OTP', 'error', 'Invalid OTP');
          } else {
            alert('Please enter complete 6-digit OTP');
          }
          return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('verifyOtpBtn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';
        
        try {
          // Verify OTP via backend API
          const success = await verifyOTP(enteredOtp, phone);
          
          if (success) {
            // User is now logged in with JWT token stored
            if (window.showToast) {
              showToast('Login successful!', 'success', 'Welcome');
            }
            
            // Clear OTP data
            localStorage.removeItem('pendingPhone');
            if (resendTimerInterval) {
              clearInterval(resendTimerInterval);
              resendTimerInterval = null;
            }
            
            // Redirect to home page
            setTimeout(() => {
              window.location.href = '../index.html';
            }, 500);
          } else {
            if (window.showToast) {
              showToast('Invalid OTP. Please try again.', 'error', 'OTP Verification Failed');
            } else {
              alert('Invalid OTP. Please try again.');
            }
            // Clear OTP inputs
            document.querySelectorAll('.otp-input').forEach(input => {
              input.value = '';
            });
            document.getElementById('otp1').focus();
          }
        } catch (error) {
          console.error('OTP verification error:', error);
          if (window.showToast) {
            showToast('OTP verification failed. Please try again.', 'error', 'Error');
          } else {
            alert('OTP verification failed. Please try again.');
          }
          // Clear OTP inputs
          document.querySelectorAll('.otp-input').forEach(input => {
            input.value = '';
          });
          document.getElementById('otp1').focus();
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // Resend OTP
    async function resendOtp() {
      const phone = otpPhoneNumber || localStorage.getItem('pendingPhone') || document.getElementById('loginPhone').value.trim();
      if (phone) {
        const success = await sendOTP(phone);
        if (success) {
          startResendTimer();
          // Clear OTP inputs
          document.querySelectorAll('.otp-input').forEach(input => {
            input.value = '';
          });
          document.getElementById('otp1').focus();
        }
      }
    }

    // Back to phone input
    function backToPhoneInput() {
      document.getElementById('loginFormContainer').style.display = 'block';
      document.getElementById('otpFormContainer').style.display = 'none';
      document.getElementById('loginPhone').focus();
      if (resendTimerInterval) {
        clearInterval(resendTimerInterval);
        resendTimerInterval = null;
      }
      otpPhoneNumber = null;
      localStorage.removeItem('pendingPhone');
    }

    window.resendOtp = resendOtp;
    window.backToPhoneInput = backToPhoneInput;

    // Setup Register OTP input navigation
    function setupRegisterOtpInputs() {
      const otpInputs = document.querySelectorAll('.register-otp-input');
      
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          e.target.value = value;
          
          if (value && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
        
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
          pastedData.split('').forEach((char, i) => {
            if (otpInputs[index + i]) {
              otpInputs[index + i].value = char;
            }
          });
          if (pastedData.length === 6) {
            otpInputs[5].focus();
          }
        });
      });
    }

    // Start register resend timer
    function startRegisterResendTimer() {
      let timeLeft = 30; // 30 seconds
      const resendLink = document.getElementById('resendRegisterOtpLink');
      const resendTimer = document.getElementById('resendRegisterTimer');
      
      if (resendLink) resendLink.style.pointerEvents = 'none';
      if (resendTimer) {
        resendTimer.style.display = 'inline';
        resendTimer.textContent = `(Resend in ${timeLeft}s)`;
      }
      
      if (registerResendTimerInterval) {
        clearInterval(registerResendTimerInterval);
      }
      
      registerResendTimerInterval = setInterval(() => {
        timeLeft--;
        if (resendTimer) {
          resendTimer.textContent = `(Resend in ${timeLeft}s)`;
        }
        
        if (timeLeft <= 0) {
          clearInterval(registerResendTimerInterval);
          if (resendLink) resendLink.style.pointerEvents = 'auto';
          if (resendTimer) resendTimer.style.display = 'none';
        }
      }, 1000);
    }

    // Register Form Handler - Send OTP
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('registerName').value.trim();
        const phone = document.getElementById('registerPhone').value.trim();
        const submitBtn = document.getElementById('registerSendOtpBtn');
        
        // Validate name
        if (name.length < 2) {
          if (window.showToast) {
            showToast('Please enter a valid name', 'error', 'Invalid Name');
          } else {
            alert('Please enter a valid name');
          }
          return;
        }
        
        // Validate phone number
        if (phone.length !== 10 || !/^[0-9]+$/.test(phone)) {
          if (window.showToast) {
            showToast('Please enter a valid 10-digit phone number', 'error', 'Invalid Phone');
          } else {
            alert('Please enter a valid 10-digit phone number');
          }
          return;
        }
        
        // Show loading state
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        
        try {
          // Store registration data temporarily
          registerOtpPhoneNumber = phone;
          localStorage.setItem('pendingRegistration', JSON.stringify({
            name: name,
            phone: phone
          }));
          
          // Send OTP via backend API
          const success = await sendOTP(phone);
          
          if (success) {
            // Hide register form, show OTP form
            document.getElementById('registerFormContainer').style.display = 'none';
            document.getElementById('registerOtpFormContainer').style.display = 'block';
            document.getElementById('registerOtpPhoneDisplay').textContent = phone;
            
            // Focus first OTP input
            setTimeout(() => {
              document.getElementById('registerOtp1').focus();
              setupRegisterOtpInputs();
              startRegisterResendTimer();
            }, 100);
          }
        } catch (error) {
          console.error('Registration error:', error);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // Register OTP Verification Form Handler
    const registerOtpForm = document.getElementById('registerOtpForm');
    if (registerOtpForm) {
      registerOtpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = registerOtpPhoneNumber || localStorage.getItem('pendingPhone') || document.getElementById('registerPhone').value.trim();
        const otp1 = document.getElementById('registerOtp1').value;
        const otp2 = document.getElementById('registerOtp2').value;
        const otp3 = document.getElementById('registerOtp3').value;
        const otp4 = document.getElementById('registerOtp4').value;
        const otp5 = document.getElementById('registerOtp5').value;
        const otp6 = document.getElementById('registerOtp6').value;
        
        const enteredOtp = otp1 + otp2 + otp3 + otp4 + otp5 + otp6;
        
        if (enteredOtp.length !== 6) {
          if (window.showToast) {
            showToast('Please enter complete 6-digit OTP', 'error', 'Invalid OTP');
          } else {
            alert('Please enter complete 6-digit OTP');
          }
          return;
        }
        
        // Get registration data
        const pendingReg = JSON.parse(localStorage.getItem('pendingRegistration') || 'null');
        
        if (!pendingReg || pendingReg.phone !== phone) {
          if (window.showToast) {
            showToast('Registration session expired. Please start again.', 'error', 'Session Expired');
          } else {
            alert('Registration session expired. Please start again.');
          }
          backToRegisterPhoneInput();
          return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('registerVerifyOtpBtn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';
        
        try {
          // Verify OTP via backend API (backend auto-creates user if doesn't exist)
          const success = await verifyOTP(enteredOtp, phone);
          
          if (success) {
            // Get user data from currentUser (set by verifyOTP)
            const user = getCurrentUser();
            
            // Update user name if we have registration name
            // Backend creates users with "New User" as default name
            if (user && pendingReg.name && (user.name === 'New User' || user.name === `User ${phone.slice(-4)}`)) {
              // Try to update username via API
              try {
                const updatedUser = await apiCall(`/user/update-username/${user.id}`, 'PUT', { 
                  fullName: pendingReg.name 
                });
                if (updatedUser && updatedUser.fullName) {
                  user.name = updatedUser.fullName;
                  user.fullName = updatedUser.fullName;
                  setCurrentUser(user);
                } else {
                  // Fallback: update locally
                  user.name = pendingReg.name;
                  user.fullName = pendingReg.name;
                  setCurrentUser(user);
                }
              } catch (err) {
                console.error('Failed to update username:', err);
                // If update fails, just use the name we have locally
                user.name = pendingReg.name;
                user.fullName = pendingReg.name;
                setCurrentUser(user);
              }
            }
            
            // Clear registration data
            localStorage.removeItem('pendingRegistration');
            localStorage.removeItem('pendingPhone');
            if (registerResendTimerInterval) {
              clearInterval(registerResendTimerInterval);
              registerResendTimerInterval = null;
            }
            
            if (window.showToast) {
              showToast('Account created successfully!', 'success', 'Welcome');
            }
            
            setTimeout(() => {
              window.location.href = '../index.html';
            }, 500);
          } else {
            if (window.showToast) {
              showToast('Invalid OTP. Please try again.', 'error', 'OTP Verification Failed');
            } else {
              alert('Invalid OTP. Please try again.');
            }
            // Clear OTP inputs
            document.querySelectorAll('.register-otp-input').forEach(input => {
              input.value = '';
            });
            document.getElementById('registerOtp1').focus();
          }
        } catch (error) {
          console.error('Registration OTP error:', error);
          if (window.showToast) {
            showToast('OTP verification failed. Please try again.', 'error', 'Error');
          } else {
            alert('OTP verification failed. Please try again.');
          }
          // Clear OTP inputs
          document.querySelectorAll('.register-otp-input').forEach(input => {
            input.value = '';
          });
          document.getElementById('registerOtp1').focus();
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // Resend Register OTP
    async function resendRegisterOtp() {
      const phone = registerOtpPhoneNumber || localStorage.getItem('pendingPhone') || document.getElementById('registerPhone').value.trim();
      if (phone) {
        const success = await sendOTP(phone);
        if (success) {
          startRegisterResendTimer();
          // Clear OTP inputs
          document.querySelectorAll('.register-otp-input').forEach(input => {
            input.value = '';
          });
          document.getElementById('registerOtp1').focus();
        }
      }
    }

    // Back to register phone input
    function backToRegisterPhoneInput() {
      document.getElementById('registerFormContainer').style.display = 'block';
      document.getElementById('registerOtpFormContainer').style.display = 'none';
      document.getElementById('registerPhone').focus();
      if (registerResendTimerInterval) {
        clearInterval(registerResendTimerInterval);
        registerResendTimerInterval = null;
      }
      registerOtpPhoneNumber = null;
      localStorage.removeItem('pendingRegistration');
      localStorage.removeItem('pendingPhone');
    }

    window.resendRegisterOtp = resendRegisterOtp;
    window.backToRegisterPhoneInput = backToRegisterPhoneInput;

    function showLoginForm() {
      document.getElementById('loginFormContainer').style.display = 'block';
      document.getElementById('registerFormContainer').style.display = 'none';
      document.getElementById('forgotPasswordContainer').style.display = 'none';
      document.getElementById('otpFormContainer').style.display = 'none';
      document.getElementById('loginTitle').textContent = 'Welcome Back';
      backToPhoneInput();
    }

    function showRegisterForm() {
      document.getElementById('loginFormContainer').style.display = 'none';
      document.getElementById('registerFormContainer').style.display = 'block';
      document.getElementById('registerOtpFormContainer').style.display = 'none';
      document.getElementById('forgotPasswordContainer').style.display = 'none';
      document.getElementById('otpFormContainer').style.display = 'none';
      document.getElementById('loginTitle').textContent = 'Create Account';
      backToRegisterPhoneInput();
    }

    function showForgotPassword() {
      document.getElementById('loginFormContainer').style.display = 'none';
      document.getElementById('registerFormContainer').style.display = 'none';
      document.getElementById('forgotPasswordContainer').style.display = 'block';
      document.getElementById('loginTitle').textContent = 'Reset Password';
    }

    window.showLoginForm = showLoginForm;
    window.showRegisterForm = showRegisterForm;
    window.showForgotPassword = showForgotPassword;

    if (getCurrentUser()) {
      updateUserUI();
    }
  </script>
</body>
</html>

