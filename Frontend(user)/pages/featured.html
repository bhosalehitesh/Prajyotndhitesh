<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Featured | V Store - Men's Fashion</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color, #f9f9f9);
      color: var(--text-color, #333);
      transition: background-color 0.3s, color 0.3s;
    }

    /* Hide floating login button on featured page */
    .floating-login-btn {
      display: none !important;
    }

    .page-header {
      padding: 40px 0 20px;
      text-align: center;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-color, #333);
      transition: color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .page-header p {
      font-size: 1.1rem;
      color: var(--text-color, #666);
      opacity: 0.8;
    }
    
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2rem;
      }
      .page-header p {
        font-size: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .page-header {
        padding: 30px 0 15px;
      }
      .page-header h1 {
        font-size: 1.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Header Component (loaded from components/header.html) -->
    <div id="header-placeholder"></div>

    <main style="flex: 1;">
      <div class="container">
        <div class="page-header">
          <h1>üî• Featured Collection</h1>
        </div>
        <p style="text-align: center; font-size: 1.1rem; color: var(--text-color, #666); opacity: 0.8; margin-top: -10px; margin-bottom: 40px;">
          Handpicked styles that define modern men ‚Äî from urban streetwear to classic fits.
        </p>

        <div id="featured-grid" class="ecommerce-grid"></div>
      </div>
    </main>

    <!-- Footer Component (loaded from components/footer.html) -->
    <div id="footer-placeholder" style="width: 100%; margin-top: auto; flex-shrink: 0;"></div>
        </div>

  <!-- Load components first, then app.js -->
  <script src="../js/load-components.js"></script>
  <script src="../js/app.js"></script>
  <script>
    // Preserve store parameter if missing (fallback)
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      if (!urlParams.get('store')) {
        // Try to get from referrer
        try {
          const referrer = document.referrer;
          if (referrer) {
            const referrerUrl = new URL(referrer);
            const referrerStore = referrerUrl.searchParams.get('store');
            if (referrerStore) {
              // Redirect to same page with store parameter
              urlParams.set('store', referrerStore);
              window.location.replace(window.location.pathname + '?' + urlParams.toString());
              return;
            }
          }
        } catch (e) {
          // Ignore errors
        }
        
        // Try to get from sessionStorage (set by other pages)
        try {
          const storedStore = sessionStorage.getItem('currentStoreSlug');
          if (storedStore) {
            urlParams.set('store', storedStore);
            window.location.replace(window.location.pathname + '?' + urlParams.toString());
            return;
          }
        } catch (e) {
          // Ignore errors
        }
      } else {
        // Store store slug in sessionStorage for future navigation
        try {
          sessionStorage.setItem('currentStoreSlug', urlParams.get('store'));
        } catch (e) {
          // Ignore errors
        }
      }
    })();
    
    // Fetch featured products (best sellers) from backend - FILTERED BY STORE
    async function loadFeaturedProducts() {
      const grid = document.getElementById('featured-grid');
      grid.innerHTML = '<p style="text-align:center;">Loading featured products...</p>';

      const baseUrl = (window.API_BASE_URL && window.API_BASE_URL()) || 'http://localhost:8080';
      
      // Get store slug from URL to filter products by store
      const urlParams = new URLSearchParams(window.location.search);
      const storeSlug = urlParams.get('store');
      
      console.log('üîç Featured Products - Store Slug from URL:', storeSlug);
      
      let sellerId = null;
      
      // If we have a store slug, get the sellerId from the store
      if (storeSlug && window.API && window.API.getStoreBySlug) {
        try {
          console.log('üìû Calling getStoreBySlug for:', storeSlug);
          const store = await window.API.getStoreBySlug(storeSlug);
          console.log('üì¶ Store data received:', store);
          
          if (store) {
            // Try multiple ways to get sellerId
            sellerId = store.seller?.sellerId || 
                      store.sellerId || 
                      (store.seller && store.seller.sellerId) ||
                      (store.seller && typeof store.seller === 'object' && store.seller.sellerId);
            
            console.log('‚úÖ Extracted sellerId:', sellerId);
            console.log('üìã Full store object:', JSON.stringify(store, null, 2));
            
            if (!sellerId) {
              console.error('‚ùå WARNING: Store found but sellerId is null/undefined!');
              console.error('Store seller object:', store.seller);
            }
          } else {
            console.error('‚ùå Store not found for slug:', storeSlug);
          }
        } catch (e) {
          console.error('‚ùå Failed to get store by slug:', e);
          console.error('Error details:', e.message, e.stack);
        }
      } else {
        if (!storeSlug) {
          console.warn('‚ö†Ô∏è No store slug in URL - will show ALL featured products from ALL sellers!');
        }
        if (!window.API) {
          console.error('‚ùå window.API is not available!');
        }
        if (!window.API?.getStoreBySlug) {
          console.error('‚ùå window.API.getStoreBySlug is not available!');
        }
      }
      
      try {
        // PREFERRED: Use store-specific featured endpoint (more reliable)
        let products = [];
        
        if (storeSlug && window.API && window.API.getStoreFeaturedProductsBySlug) {
          // Use the new dedicated endpoint
          console.log('üéØ Using getStoreFeaturedProductsBySlug API function');
          products = await window.API.getStoreFeaturedProductsBySlug(storeSlug);
        } else if (storeSlug) {
          // Direct API call to store-specific endpoint
          const featuredUrl = `${baseUrl}/api/public/store/${encodeURIComponent(storeSlug)}/featured`;
          console.log('üéØ Using store-specific featured endpoint:', featuredUrl);
          const res = await fetch(featuredUrl);
          if (!res.ok) {
            console.error('‚ùå API request failed:', res.status, res.statusText);
            throw new Error(`Failed to load featured products: ${res.status} ${res.statusText}`);
          }
          products = await res.json();
        } else if (sellerId) {
          // Fallback: Use sellerId parameter
          const featuredUrl = `${baseUrl}/api/products/featured?sellerId=${sellerId}`;
          console.log('üìå Using sellerId parameter:', featuredUrl);
          const res = await fetch(featuredUrl);
          if (!res.ok) {
            console.error('‚ùå API request failed:', res.status, res.statusText);
            throw new Error(`Failed to load featured products: ${res.status} ${res.statusText}`);
          }
          products = await res.json();
        } else {
          // Last resort: Get all featured products (should not happen for store pages)
          console.warn('‚ö†Ô∏è WARNING: No store slug or sellerId - showing ALL featured products!');
          const featuredUrl = `${baseUrl}/api/products/featured`;
          const res = await fetch(featuredUrl);
          if (!res.ok) {
            throw new Error(`Failed to load featured products: ${res.status} ${res.statusText}`);
          }
          products = await res.json();
        }
        
        console.log('‚úÖ Received products:', products?.length || 0, 'items');

        if (!Array.isArray(products) || products.length === 0) {
          grid.innerHTML = '<p style="text-align:center;">No featured products yet.</p>';
          return;
        }

        grid.innerHTML = products.map(p => {
          const name = p.productName || 'Product';
          const price = p.sellingPrice || 0;
          const mrp = p.mrp || '';
          const img = (p.productImages && p.productImages[0]) || p.socialSharingImage || '../assets/genz/ts.webp';
          const brand = p.businessCategory || 'V Store';
          // Use product ID for API-based product detail page
          const productId = p.productsId || p.productId || p.id;
          const urlParams = new URLSearchParams(window.location.search);
          const storeSlug = urlParams.get('store');
          const storeParam = storeSlug ? `&store=${encodeURIComponent(storeSlug)}` : '';
          const detailUrl = productId 
            ? `product-detail.html?id=${encodeURIComponent(productId)}${storeParam}`
            : `product-detail.html?name=${encodeURIComponent(name)}&price=${price}&originalPrice=${mrp || price}&image=${encodeURIComponent(img)}&brand=${encodeURIComponent(brand)}${storeParam}`;
          return `
            <div class="ecommerce-product-card" onclick="window.location.href='${detailUrl}'">
              <img src="${img}" alt="${name}" />
              <div class="product-info">
                <div class="product-brand">${brand}</div>
                <div class="product-name">${name}</div>
                <div class="product-price">
                  <span class="current-price">‚Çπ${price}</span>
                  ${mrp && mrp > price ? `<span class="original-price">‚Çπ${mrp}</span>` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                  <button class="add-to-cart-btn"
                    data-name="${name}"
                    data-price="${price}"
                    data-brand="${brand}"
                    data-img="${img}"
                    data-original-price="${mrp || price}"
                    onclick="event.stopPropagation(); addToCartFromButton(this)"
                    style="flex:1;">Add to Cart</button>
                  <button class="wishlist-btn"
                    data-name="${name}"
                    data-price="${price}"
                    data-original-price="${mrp || price}"
                    data-brand="${brand}"
                    data-img="${img}"
                    onclick="event.stopPropagation(); addToWishlistFromProduct(this)"
                    title="Add to Wishlist"
                    style="padding: 12px; min-width: 48px; height: 48px; background: var(--muted-white, #f5f5f5); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Update wishlist icons for existing wishlisted items
        grid.querySelectorAll('.wishlist-btn').forEach(btn => {
          const isWishlisted = isProductInWishlist(btn.getAttribute('data-name'));
          updateWishlistButtonIcon(btn, isWishlisted);
        });
      } catch (e) {
        console.error('Failed to load featured products', e);
        grid.innerHTML = '<p style="text-align:center;">Failed to load featured products. Please try again.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', loadFeaturedProducts);

    // Helper function to check if product is in wishlist
    function isProductInWishlist(productName) {
      if (window.WishlistUtils) {
        const wishlist = window.WishlistUtils.getWishlist();
        return wishlist.some(item => item.name === productName);
      } else {
        const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        return wishlist.some(item => item.name === productName);
      }
    }

    // Helper function to update wishlist button icon
    function updateWishlistButtonIcon(button, isWishlisted) {
      if (isWishlisted) {
        // Replace with GIF
        button.innerHTML = `<img src="../assets/gifs/wishlist.gif" alt="Wishlisted" style="width: 20px; height: 20px; object-fit: contain;" />`;
        button.title = 'Remove from Wishlist';
      } else {
        // Replace with SVG
        button.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>`;
        button.title = 'Add to Wishlist';
      }
    }

    // Add to wishlist from product card
    function addToWishlistFromProduct(button) {
      const name = button.getAttribute('data-name');
      const price = parseInt(button.getAttribute('data-price'));
      const brand = button.getAttribute('data-brand') || 'V Store';
      const img = button.getAttribute('data-img') || '';
      const originalPrice = parseInt(button.getAttribute('data-original-price')) || price;
      
      // Check if product is already in wishlist
      const isCurrentlyWishlisted = isProductInWishlist(name);
      
      if (window.WishlistUtils) {
        if (isCurrentlyWishlisted) {
          // Remove from wishlist
          window.WishlistUtils.removeItemFromWishlist(name);
          updateWishlistButtonIcon(button, false);
          if (window.showToast) {
            showToast(`${name} removed from wishlist`, 'success', 'Wishlist');
          }
        } else {
          // Add to wishlist
          const added = window.WishlistUtils.addItemToWishlist({
            name: name,
            price: price,
            originalPrice: originalPrice,
            image: img,
            brand: brand,
            size: 'Default',
            color: 'Default'
          });
          
          if (added) {
            updateWishlistButtonIcon(button, true);
            if (window.showToast) {
              showToast(`${name} added to wishlist!`, 'success', 'Wishlist');
            }
          }
        }
        
        window.WishlistUtils.updateWishlistCount();
      } else {
        // Fallback to localStorage
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        const existingItemIndex = wishlist.findIndex(item => item.name === name);
        
        if (existingItemIndex !== -1) {
          // Remove from wishlist
          wishlist.splice(existingItemIndex, 1);
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
          updateWishlistButtonIcon(button, false);
          if (window.showToast) {
            showToast(`${name} removed from wishlist`, 'success', 'Wishlist');
          }
        } else {
          // Add to wishlist
          wishlist.push({
            name: name,
            price: price,
            originalPrice: originalPrice,
            image: img,
            brand: brand
          });
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
          updateWishlistButtonIcon(button, true);
          if (window.showToast) {
            showToast(`${name} added to wishlist!`, 'success', 'Wishlist');
          }
        }
        
        // Update wishlist count
        const wishlistCountElements = document.querySelectorAll('#wishlistCount, .wishlist-count');
        wishlistCountElements.forEach(el => {
          if (el) {
            el.textContent = wishlist.length;
            if (wishlist.length > 0) {
              el.style.display = 'inline-block';
            } else {
              el.style.display = 'none';
            }
          }
        });
      }
    }

    // Initialize wishlist button states
    function initializeWishlistButtons() {
      const wishlistButtons = document.querySelectorAll('.wishlist-btn');
      wishlistButtons.forEach(button => {
        const productName = button.getAttribute('data-name');
        if (productName && isProductInWishlist(productName)) {
          updateWishlistButtonIcon(button, true);
        }
      });
    }

    // Make functions globally available
    window.addToWishlistFromProduct = addToWishlistFromProduct;
    window.isProductInWishlist = isProductInWishlist;
    window.updateWishlistButtonIcon = updateWishlistButtonIcon;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeWishlistButtons();
    });

    // Add to cart from button (prevents navigation)
    function addToCartFromButton(button) {
      const name = button.getAttribute('data-name');
      const price = parseInt(button.getAttribute('data-price'));
      const brand = button.getAttribute('data-brand') || 'V Store';
      const img = button.getAttribute('data-img') || '';
      
      // Use unified cart system if available
      if (window.CartUtils) {
        window.CartUtils.addItemToCart({
          name: name,
          price: price,
          image: img,
          brand: brand,
          size: 'Default',
          color: 'Default'
        });
      } else {
        // Fallback to localStorage
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const existingItem = cart.find(item => item.name === name);
        
        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push({
            name: name,
            price: price,
            image: img,
            brand: brand,
            quantity: 1
          });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      
      // Update cart count
      if (window.CartUtils) {
        window.CartUtils.updateCartCount();
      } else {
        const cartCount = document.getElementById('cartCount');
        if (cartCount) {
          const cart = JSON.parse(localStorage.getItem('cart') || '[]');
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartCount.textContent = totalItems;
        }
      }
      
      // Show feedback
      const originalText = button.textContent;
      button.textContent = '‚úì Added!';
      button.style.background = '#4caf50';
      button.style.color = '#fff';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '';
        button.style.color = '';
      }, 1500);
    }

    // Make function globally available
    window.addToCartFromButton = addToCartFromButton;

    // Update Light Mode text based on current theme (optimized)
    function updateLightModeText() {
      const sidebarLightModeText = document.getElementById('sidebarLightModeText');
      if (sidebarLightModeText) {
        const isDarkMode = document.body.classList.contains('dark-mode');
        sidebarLightModeText.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
      }
    }

    // Update on theme change (wait for app.js to initialize first)
    function setupLightModeTextUpdate() {
      const darkModeSwitch = document.getElementById('dark-mode-switch');
      if (!darkModeSwitch) {
        setTimeout(setupLightModeTextUpdate, 50);
        return;
      }
      darkModeSwitch.addEventListener('change', function() {
        requestAnimationFrame(updateLightModeText);
      });
      updateLightModeText();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(setupLightModeTextUpdate, 150);
      });
    } else {
      setTimeout(setupLightModeTextUpdate, 150);
    }
  </script>
</body>
</html>

