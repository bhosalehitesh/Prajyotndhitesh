<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Categories | V Store - Men's Fashion</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    // CRITICAL: Hide default categories IMMEDIATELY if store slug exists (runs before page renders)
    (function() {
      try {
        const search = window.location.search || window.location.href.split('?')[1] || '';
        const hasStoreParam = search.includes('store=');
        
        if (hasStoreParam) {
          // Extract store slug
          const match = search.match(/[?&]store=([^&]*)/);
          if (match && match[1]) {
            const storeSlug = decodeURIComponent(match[1].trim());
            if (storeSlug) {
              // Inject CSS immediately to hide defaults - CRITICAL
              const style = document.createElement('style');
              style.id = 'hide-default-categories';
              style.textContent = `
                #category-grid .category-card[data-default-category="true"],
                .category-grid .category-card[data-default-category="true"],
                .category-card[data-default-category="true"] {
                  display: none !important;
                  visibility: hidden !important;
                  opacity: 0 !important;
                  height: 0 !important;
                  width: 0 !important;
                  overflow: hidden !important;
                  margin: 0 !important;
                  padding: 0 !important;
                  pointer-events: none !important;
                  position: absolute !important;
                  left: -9999px !important;
                }
              `;
              
              // Try to add to head immediately
              if (document.head) {
                document.head.appendChild(style);
              } else if (document.documentElement) {
                document.documentElement.appendChild(style);
              } else {
                // Fallback: wait for DOM
                const addStyle = function() {
                  if (document.head) {
                    document.head.appendChild(style);
                  } else {
                    setTimeout(addStyle, 10);
                  }
                };
                addStyle();
              }
              
              console.log('✅ CSS injected to hide default categories for store:', storeSlug);
              window.__storeSlug = storeSlug; // Store for debugging
            }
          }
        } else {
          // Mark that there's no store slug
          document.documentElement.setAttribute('data-no-store-slug', 'true');
        }
      } catch (e) {
        console.error('❌ Error hiding default categories:', e);
      }
    })();
    // Ensure store param is present (pull from referrer or sessionStorage if missing)
    (function() {
      try {
        const params = new URLSearchParams(window.location.search);
        if (!params.get('store')) {
          let storeFromRef = null;
          try {
            if (document.referrer) {
              const ref = new URL(document.referrer);
              storeFromRef = ref.searchParams.get('store');
            }
          } catch (e) {}
          let storeFromSession = null;
          try {
            storeFromSession = sessionStorage.getItem('currentStoreSlug');
          } catch (e) {}
          const chosen = storeFromRef || storeFromSession;
          if (chosen) {
            params.set('store', chosen);
            const newUrl = window.location.pathname + '?' + params.toString();
            window.location.replace(newUrl);
          }
        } else {
          // Persist for future pages
          try {
            sessionStorage.setItem('currentStoreSlug', params.get('store'));
          } catch (e) {}
        }
      } catch (e) {
        // swallow
      }
    })();
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color, #f5f5f5);
      color: var(--text-color, #333);
      transition: background-color 0.3s, color 0.3s;
    }
    
    main {
      background: var(--bg-color);
    }
    
    .container {
      background: transparent;
    }
    
    .page-header {
      padding: 40px 0 20px;
      text-align: center;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-color, #333);
      transition: color 0.3s;
    }
    
    .page-header p {
      font-size: 1.1rem;
      color: var(--text-color, #666);
      opacity: 0.8;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px 0 60px;
    -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .category-card {
      background: var(--card-bg, #fff);
      border-radius: 0;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
      text-decoration: none;
      color: inherit;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .category-card img {
      width: 100%;
      height: 280px;
      min-height: 280px;
      max-height: 280px;
      object-fit: cover;
      object-position: center;
      display: block;
      transition: transform 0.3s ease;
      background: var(--muted-white, #f5f5f5);
    }

    .category-card:hover img {
      transform: scale(1.02);
    }

    .category-card-content {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .category-card .category-brand {
      font-size: 0.85rem;
      color: var(--text-color, #666);
      opacity: 0.8;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .category-card h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color, #333);
      margin-bottom: 8px;
      line-height: 1.4;
      transition: color 0.3s;
    }

    .category-count {
      font-size: 0.85rem;
      color: var(--text-color, #666);
      opacity: 0.7;
      margin-top: auto;
      padding-top: 12px;
    }

    /* Hide default categories when store slug exists in URL */
    /* Note: Default categories are hidden via inline styles injected by JavaScript */

    @media (max-width: 1200px) {
      .category-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .page-header {
        padding: 40px 0 20px;
      }
      .page-header h1 {
        font-size: 2rem;
      }
      .page-header p {
        font-size: 1rem;
      }
      .category-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
      }
      .category-card img {
        height: 240px;
        min-height: 240px;
        max-height: 240px;
      }
    }
    
    @media (max-width: 480px) {
      .page-header {
        padding: 30px 0 15px;
      }
      .page-header h1 {
        font-size: 1.75rem;
      }
      .category-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .category-card img {
        height: 240px;
        min-height: 240px;
        max-height: 240px;
      }
      .category-card-content {
        padding: 12px;
      }
      .category-card h3 {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Header Component (loaded from components/header.html) -->
    <div id="header-placeholder"></div>

    <main style="flex: 1;">
      <div class="container">
        <div class="page-header">
          <h1>Shop by Category</h1>
          <p>Find your perfect style across all fashion essentials</p>
        </div>

        <div class="category-grid" id="category-grid">
          <!-- Categories will be loaded dynamically from API -->
        </div>
      </div>
    </main>

    <!-- Footer Component (loaded from components/footer.html) -->
    <div id="footer-placeholder" style="width: 100%; margin-top: auto; flex-shrink: 0;"></div>
        </div>

  <!-- Load components first, then API, then app.js -->
  <script src="../js/load-components.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/app.js"></script>
  <script>
    // Load categories from API - Store-specific
    async function loadCategoriesFromAPI() {
      const storeSlug = new URLSearchParams(window.location.search).get('store');
      const categoryGrid = document.getElementById('category-grid');
      
      if (!categoryGrid) {
        console.error('Category grid not found');
        return;
      }

      // Wait for API to be available (max 5 seconds)
      let retries = 0;
      const maxRetries = 50;
      while (!window.API && retries < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }

      if (!window.API) {
        console.error('API not loaded after waiting');
        if (storeSlug) {
          categoryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-color, #666);">Failed to load API. Please refresh the page.</div>';
        }
        return;
      }

      try {
        let categories = [];
        
        // If store slug is present, get store-specific categories
        if (storeSlug) {
          if (window.API.getStoreCategoriesBySlug) {
            console.log('Loading categories for store:', storeSlug);
            categories = await window.API.getStoreCategoriesBySlug(storeSlug);
            console.log('Received categories:', categories);
          } else {
            console.error('getStoreCategoriesBySlug function not available');
          }
        } else {
          // No store slug: do NOT load all categories (avoid cross-store leakage)
          console.warn('No store slug provided; skipping category load.');
          categories = [];
        }

        // ALWAYS clear grid completely
        categoryGrid.innerHTML = '';
        console.log('Grid cleared');

        // If we have categories from API, update the grid
        if (Array.isArray(categories) && categories.length > 0) {
          console.log(`Adding ${categories.length} categories to grid`);
          categories.forEach((category) => {
            const categoryName = category.categoryName || category.name || 'Category';
            const categoryImage = category.categoryImage || category.image || '';
            const categoryId = category.category_id || category.id || category.categoryId || '';
            const safeName = (categoryName || '').trim();
            // Build category URL with name, categoryId, and store slug
            let categoryUrl = `category.html?name=${encodeURIComponent(safeName)}`;
            if (categoryId) {
              categoryUrl += `&categoryId=${encodeURIComponent(categoryId)}`;
            }
            if (storeSlug) {
              categoryUrl += `&store=${encodeURIComponent(storeSlug)}`;
            }
            
            const card = document.createElement('a');
            card.href = categoryUrl;
            card.className = 'category-card';
            
            const imageSrc = categoryImage || '';
            
            card.innerHTML = `
              <img src="${imageSrc}" alt="${categoryName}" onerror="this.style.background='var(--muted-white, #f0f0f0)';" />
              <div class="category-card-content">
                <div class="category-brand">Category</div>
                <h3>${categoryName}</h3>
                <div class="category-count">View Collection</div>
              </div>
            `;
            
            categoryGrid.appendChild(card);
          });
        } else {
          // If no categories found, show message
          categoryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-color, #666);">No categories found for this store.</div>';
        }
      } catch (error) {
        console.error('Failed to load categories from API:', error);
        // Clear grid if store slug exists, even on error
        if (storeSlug) {
          // Double-check: remove any remaining defaults
          const remainingDefaults = categoryGrid.querySelectorAll('[data-default-category="true"]');
          if (remainingDefaults.length > 0) {
            remainingDefaults.forEach(cat => cat.remove());
          }
          categoryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-color, #666);">Failed to load categories. Please try again later.</div>';
        }
        // If no store slug, keep default categories
      }
      
      // Final safety check: ensure no defaults remain if store slug exists
      if (storeSlug) {
        setTimeout(() => {
          const finalCheck = categoryGrid.querySelectorAll('[data-default-category="true"]');
          if (finalCheck.length > 0) {
            console.warn('Found remaining default categories, removing them');
            finalCheck.forEach(cat => cat.remove());
            if (categoryGrid.children.length === 0) {
              categoryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-color, #666);">No categories available.</div>';
            }
          }
        }, 1000);
      }
    }

    // Clear default categories immediately on page load if store slug exists
    function clearDefaultCategories() {
      const storeSlug = new URLSearchParams(window.location.search).get('store');
      if (storeSlug) {
        const categoryGrid = document.getElementById('category-grid');
        if (categoryGrid) {
          // Remove all default categories
          const defaultCategories = categoryGrid.querySelectorAll('[data-default-category="true"]');
          defaultCategories.forEach(cat => cat.remove());
          
          // If grid is now empty, show loading message
          if (categoryGrid.children.length === 0) {
            categoryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-color, #666);">Loading categories...</div>';
          }
          console.log('Cleared default categories for store:', storeSlug);
        }
      }
    }

    // Clear immediately when script runs
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', clearDefaultCategories);
    } else {
      clearDefaultCategories();
    }

    // Load categories on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(loadCategoriesFromAPI, 300);
      });
    } else {
      // Wait for API scripts to load
      setTimeout(loadCategoriesFromAPI, 300);
    }

    // Update navigation links to preserve store parameter
    function updateNavigationLinks() {
      const storeSlug = new URLSearchParams(window.location.search).get('store');
      if (!storeSlug) return;

      // Update all navigation links
      document.querySelectorAll('a[href*="categories.html"], a[href*="products.html"], a[href*="category.html"]').forEach(link => {
        const href = link.getAttribute('href');
        if (href && !href.includes('store=')) {
          const separator = href.includes('?') ? '&' : '?';
          link.setAttribute('href', href + separator + 'store=' + encodeURIComponent(storeSlug));
        }
      });
    }

    // Update links after header loads
    setTimeout(updateNavigationLinks, 500);
    // Also update when header is loaded
    const observer = new MutationObserver(() => {
      updateNavigationLinks();
    });
    observer.observe(document.body, { childList: true, subtree: true });
  </script>
  <script>
    // Search functionality
    const searchBtn = document.getElementById('searchBtn');
    const searchModal = document.getElementById('searchModal');
    const searchInput = document.getElementById('searchInput');
    const searchClose = document.getElementById('searchClose');
    const searchResults = document.getElementById('searchResults');

    // Product data for search
    const allProducts = [
      { name: 'Colourblocked Polo T-shirt', price: 593, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Pure Cotton Custom Fit Shirt', price: 917, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Polo Collar Slim Fit T-shirt', price: 929, img: 'products.html', brand: 'Louis Philippe Jeans' },
      { name: 'Pure Cotton Casual Shirt', price: 993, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Classic Fit Formal Shirt', price: 849, img: 'products.html', brand: 'Louis Philippe Jeans' },
      { name: 'Regular Fit Cotton T-shirt', price: 699, img: 'products.html', brand: 'Allen Solly' },
      { name: 'Slim Fit Cotton Shirt', price: 799, img: 'products.html', brand: 'Louis Philippe Jeans' },
      { name: 'Oversized Graphic Tee', price: 499, img: 'featured.html', brand: 'V Store' },
      { name: 'Minimalist Hoodie', price: 799, img: 'featured.html', brand: 'V Store' },
      { name: 'Baggy Fit Jeans', price: 999, img: 'featured.html', brand: 'V Store' },
      { name: 'Co-ord Set', price: 1199, img: 'featured.html', brand: 'V Store' }
    ];

    function performSearch(query) {
      const lowerQuery = query.toLowerCase().trim();
      if (lowerQuery === '') {
        searchResults.innerHTML = '';
        return;
      }

      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(lowerQuery) ||
        p.brand.toLowerCase().includes(lowerQuery)
      );

      searchResults.innerHTML = '';
      
      if (filtered.length === 0) {
        searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-color, #666);">No products found</div>';
        return;
      }

      filtered.forEach(product => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px;';
        item.innerHTML = `
          <div style="flex: 1;">
            <h4 style="margin: 0 0 4px 0; color: var(--text-color, #333); font-size: 1rem;">${product.name}</h4>
            <p style="margin: 0; color: #e53935; font-weight: 600; font-size: 0.9rem;">₹${product.price}</p>
            <p style="margin: 4px 0 0 0; color: var(--text-color, #666); font-size: 0.85rem;">${product.brand}</p>
          </div>
        `;
        item.addEventListener('mouseenter', () => {
          item.style.background = 'var(--muted-white, #f5f5f5)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.background = 'transparent';
        });
        item.addEventListener('click', () => {
          window.location.href = product.img;
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        });
        searchResults.appendChild(item);
      });
    }

    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        searchModal.style.display = 'flex';
        setTimeout(() => searchInput.focus(), 100);
      });
    }

    if (searchClose) {
      searchClose.addEventListener('click', () => {
        searchModal.style.display = 'none';
        searchInput.value = '';
        searchResults.innerHTML = '';
      });
    }

    if (searchModal) {
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        }
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        performSearch(e.target.value);
      });
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchModal.style.display = 'none';
          searchInput.value = '';
          searchResults.innerHTML = '';
        }
      });
    }

    // Mobile Menu Toggle
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mobileNav = document.getElementById("mobileNav");
    if (mobileMenuBtn && mobileNav) {
      mobileMenuBtn.addEventListener("click", () => {
        mobileNav.classList.toggle("active");
      });
      document.addEventListener("click", (e) => {
        if (!mobileMenuBtn.contains(e.target) && !mobileNav.contains(e.target)) {
          mobileNav.classList.remove("active");
        }
      });
      mobileNav.querySelectorAll(".nav-item").forEach(item => {
        item.addEventListener("click", () => {
          mobileNav.classList.remove("active");
        });
      });
    }

    // Profile Sidebar Toggle
    const profileSidebar = document.getElementById('profileSidebar');
    const profileSidebarOverlay = document.getElementById('profileSidebarOverlay');
    const profileSidebarClose = document.getElementById('profileSidebarClose');
    const loginDropdownBtn = document.getElementById('loginDropdownBtn');
    const loginDropdown = document.getElementById('loginDropdown');
    const lightModeBtn = document.getElementById('lightModeBtn');
    const sidebarLightModeBtn = document.getElementById('sidebarLightMode');

    function openProfileSidebar() {
      if (profileSidebar) {
        profileSidebar.classList.add('active');
        if (profileSidebarOverlay) {
          profileSidebarOverlay.classList.add('active');
        }
        document.body.style.overflow = 'hidden';
      }
    }

    function closeProfileSidebar() {
      if (profileSidebar) {
        profileSidebar.classList.remove('active');
        if (profileSidebarOverlay) {
          profileSidebarOverlay.classList.remove('active');
        }
        document.body.style.overflow = '';
      }
    }

    // Open sidebar when clicking profile button
    if (loginDropdownBtn) {
      loginDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        openProfileSidebar();
      });
    }

    // Close sidebar
    if (profileSidebarClose) {
      profileSidebarClose.addEventListener('click', () => {
        closeProfileSidebar();
      });
    }

    // Close sidebar when clicking overlay
    if (profileSidebarOverlay) {
      profileSidebarOverlay.addEventListener('click', () => {
        closeProfileSidebar();
      });
    }

    // Close sidebar on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && profileSidebar && profileSidebar.classList.contains('active')) {
        closeProfileSidebar();
      }
    });

    // Light Mode toggle from sidebar
    if (sidebarLightModeBtn) {
      sidebarLightModeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const darkModeSwitch = document.getElementById('dark-mode-switch');
        if (darkModeSwitch) {
          darkModeSwitch.checked = !darkModeSwitch.checked;
          darkModeSwitch.dispatchEvent(new Event('change'));
        }
      });
    }

    // Light Mode toggle from dropdown (if exists)
    if (lightModeBtn) {
      lightModeBtn.addEventListener('click', () => {
        const darkModeSwitch = document.getElementById('dark-mode-switch');
        if (darkModeSwitch) {
          darkModeSwitch.checked = !darkModeSwitch.checked;
          darkModeSwitch.dispatchEvent(new Event('change'));
        }
      });
    }

    // Update Light Mode text based on current theme (optimized)
    function updateLightModeText() {
      const lightModeText = document.getElementById('lightModeText');
      const sidebarLightModeText = document.getElementById('sidebarLightModeText');
      const isDarkMode = document.body.classList.contains('dark-mode');
      const text = isDarkMode ? 'Light Mode' : 'Dark Mode';
      
      if (lightModeText) {
        lightModeText.textContent = text;
      }
      if (sidebarLightModeText) {
        sidebarLightModeText.textContent = text;
      }
    }

    // Update on theme change (wait for app.js to initialize first)
    function setupLightModeTextUpdate() {
      const darkModeSwitch = document.getElementById('dark-mode-switch');
      if (!darkModeSwitch) {
        setTimeout(setupLightModeTextUpdate, 50);
        return;
      }
      darkModeSwitch.addEventListener('change', function() {
        requestAnimationFrame(updateLightModeText);
      });
      updateLightModeText();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(setupLightModeTextUpdate, 150);
      });
    } else {
      setTimeout(setupLightModeTextUpdate, 150);
    }

    // Close sidebar when clicking menu items (except light mode toggle)
    const sidebarMenuItems = document.querySelectorAll('.profile-sidebar-item');
    sidebarMenuItems.forEach(item => {
      if (item.id !== 'sidebarLightMode') {
        item.addEventListener('click', () => {
          setTimeout(() => {
            closeProfileSidebar();
          }, 100);
        });
      }
    });
  </script>
</body>
</html>
