<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment | V Store</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    
    main {
      background: var(--bg-color);
      padding: 20px 0;
      min-height: calc(100vh - 200px);
    }

    .payment-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 28px;
    }
    
    /* Progress Bar */
    .payment-progress {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      transition: background-color 0.3s, border-color 0.3s;
    }
    
    body.dark-mode .payment-progress {
      border-color: rgba(255,255,255,0.1);
    }
    
    .progress-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      position: relative;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 2;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      border: 2px solid #ddd;
      background: var(--card-bg);
      color: #999;
      transition: all 0.3s;
    }
    
    body.dark-mode .step-circle {
      border-color: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.5);
    }
    
    .step-circle.completed {
      background: #ff6d2e;
      border-color: #ff6d2e;
      color: #fff;
    }
    
    .step-circle.active {
      background: #ff6d2e;
      border-color: #ff6d2e;
      color: #fff;
    }
    
    .step-label {
      font-size: 0.9rem;
      color: var(--text-color);
      font-weight: 500;
      opacity: 0.7;
    }
    
    .step-label.active {
      color: #ff6d2e;
      font-weight: 600;
      opacity: 1;
    }
    
    .progress-line {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #ddd;
      z-index: 1;
    }
    
    body.dark-mode .progress-line {
      background: rgba(255,255,255,0.1);
    }
    
    .progress-fill {
      height: 100%;
      background: #ff6d2e;
      width: 100%;
      transition: width 0.3s;
    }
    
    /* Main Layout */
    .payment-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    @media (max-width: 968px) {
      .payment-layout {
        grid-template-columns: 1fr;
      }
    }
    
    /* Payment Section */
    .payment-section {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      transition: background-color 0.3s, border-color 0.3s;
    }
    
    body.dark-mode .payment-section {
      border-color: rgba(255,255,255,0.1);
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 24px;
    }
    
    /* Payment Methods */
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .payment-method {
      padding: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    body.dark-mode .payment-method {
      border-color: rgba(255,255,255,0.1);
    }

    .payment-method:hover {
      border-color: #ff6d2e;
      background: rgba(255, 109, 46, 0.05);
    }

    .payment-method.active {
      border-color: #ff6d2e;
      background: rgba(255, 109, 46, 0.1);
    }
    
    .payment-method input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .payment-method-label {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .payment-method-name {
      font-weight: 600;
      color: var(--text-color);
      font-size: 1rem;
    }
    
    .payment-method-desc {
      font-size: 0.85rem;
      color: var(--text-color);
      opacity: 0.7;
    }
    
    /* Order Summary */
    .order-summary {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      transition: background-color 0.3s, border-color 0.3s;
      position: sticky;
      top: 20px;
    }
    
    body.dark-mode .order-summary {
      border-color: rgba(255,255,255,0.1);
    }
    
    .summary-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 20px;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      color: var(--text-color);
    }
    
    body.dark-mode .summary-item {
      border-bottom-color: rgba(255,255,255,0.1);
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .summary-item-label {
      font-weight: 500;
    }
    
    .summary-item-value {
      font-weight: 600;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      padding: 16px 0;
      margin-top: 12px;
      border-top: 2px solid rgba(0,0,0,0.1);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
    }
    
    body.dark-mode .summary-total {
      border-top-color: rgba(255,255,255,0.2);
    }
    
    /* Order Items */
    .order-items-list {
      margin-bottom: 20px;
    }
    
    .order-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    
    body.dark-mode .order-item {
      border-bottom-color: rgba(255,255,255,0.1);
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-item-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: #f0f0f0;
    }
    
    body.dark-mode .order-item-image {
      background: rgba(255,255,255,0.1);
    }
    
    .order-item-details {
      flex: 1;
    }
    
    .order-item-name {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 4px;
    }
    
    .order-item-price {
      color: var(--text-color);
      opacity: 0.7;
      font-size: 0.9rem;
    }
    
    /* Buttons */
    .pay-button {
      width: 100%;
      padding: 16px;
      background: #ff6d2e;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 24px;
    }

    .pay-button:hover {
      background: #e55a1f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 109, 46, 0.3);
    }

    .pay-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Messages */
    .error-message {
      background: #ffe6e6;
      color: #d32f2f;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }
    
    body.dark-mode .error-message {
      background: rgba(211, 47, 47, 0.2);
    }
    
    .success-message {
      background: #e6ffe6;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }
    
    body.dark-mode .success-message {
      background: rgba(46, 125, 50, 0.2);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-color);
      opacity: 0.7;
    }
    
    .empty-state h2 {
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <main>
    <div class="payment-container">
      <!-- Progress Bar -->
      <div class="payment-progress">
        <div class="progress-steps">
          <div class="progress-line">
            <div class="progress-fill" style="width: 100%;"></div>
          </div>
          <div class="progress-step">
            <div class="step-circle completed">✓</div>
            <div class="step-label">Cart</div>
        </div>
          <div class="progress-step">
            <div class="step-circle completed">✓</div>
            <div class="step-label">Checkout</div>
          </div>
          <div class="progress-step">
            <div class="step-circle active">3</div>
            <div class="step-label active">Payment</div>
        </div>
      </div>
    </div>

      <div class="payment-layout">
        <!-- Payment Section -->
        <div class="payment-section">
          <h2 class="section-title">Select Payment Method</h2>
          
          <div id="errorMessage" class="error-message"></div>
          <div id="successMessage" class="success-message"></div>
          
          <div class="payment-methods">
            <label class="payment-method active" id="paymentMethodRazorpay">
              <input type="radio" name="paymentMethod" value="razorpay" checked>
              <div class="payment-method-label">
                <div class="payment-method-name">Card / UPI / Wallet</div>
                <div class="payment-method-desc">Pay securely with Razorpay</div>
              </div>
            </label>
            
            <label class="payment-method" id="paymentMethodCOD">
              <input type="radio" name="paymentMethod" value="cod">
              <div class="payment-method-label">
                <div class="payment-method-name">Cash on Delivery (COD)</div>
                <div class="payment-method-desc">Pay when you receive your order</div>
              </div>
            </label>
            </div>

          <button id="payButton" class="pay-button" onclick="processPayment()">
            Pay Now
          </button>
            </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <h3 class="summary-title">Order Summary</h3>
          
          <div id="orderItemsContainer" class="order-items-list">
            <!-- Order items will be loaded here -->
            </div>

          <div class="summary-item">
            <span class="summary-item-label">Subtotal</span>
            <span class="summary-item-value" id="subtotal">₹0</span>
            </div>

          <div class="summary-item">
            <span class="summary-item-label">Shipping</span>
            <span class="summary-item-value" id="shipping">Free</span>
          </div>

          <div class="summary-total">
            <span>Total</span>
            <span id="totalAmount">₹0</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  
  <script>
    // Auto-detect backend URL
    function getBackendUrl() {
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:8080';
      }
      
      return `${protocol}//${hostname}:8080`;
    }

    const API_BASE = 'http://192.168.1.21:8080';
    console.log('Backend URL:', API_BASE);

    let orderData = null;
    let orderId = null;

    // Load order data from localStorage or URL
    function loadOrderData() {
      // Try to get from localStorage first
      const savedOrder = localStorage.getItem('pendingOrder');
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const selectedAddress = JSON.parse(localStorage.getItem('selectedAddress') || '{}');
      
      if (savedOrder) {
        try {
          orderData = JSON.parse(savedOrder);
          orderId = orderData.orderId || Date.now();
        } catch (e) {
          console.error('Error parsing saved order:', e);
        }
      }
      
      // If no saved order, create from cart
      if (!orderData && cart.length > 0) {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        orderData = {
          items: cart,
          subtotal: subtotal,
          shipping: 0,
          total: subtotal,
          address: selectedAddress,
          orderId: Date.now()
        };
        orderId = orderData.orderId;
      }
      
      // If still no data, show empty state
      if (!orderData || !orderData.items || orderData.items.length === 0) {
        document.querySelector('.payment-layout').innerHTML = `
          <div class="empty-state">
            <h2>No items to pay for</h2>
            <p>Your cart is empty. Please add items to your cart first.</p>
            <a href="../index.html" style="color: #ff6d2e; margin-top: 20px; display: inline-block;">Continue Shopping</a>
          </div>
        `;
        return;
      }
      
      renderOrderSummary();
    }

    // Render order summary
    function renderOrderSummary() {
      if (!orderData) return;
      
      const itemsContainer = document.getElementById('orderItemsContainer');
      const subtotalEl = document.getElementById('subtotal');
      const totalEl = document.getElementById('totalAmount');
      
      // Render items
      itemsContainer.innerHTML = orderData.items.map(item => `
        <div class="order-item">
          <img src="${item.image || '../assets/placeholder.png'}" alt="${item.name}" class="order-item-image" onerror="this.src='../assets/placeholder.png'">
          <div class="order-item-details">
            <div class="order-item-name">${item.name}</div>
            <div class="order-item-price">₹${item.price} × ${item.quantity}</div>
          </div>
          </div>
      `).join('');
      
      // Update totals
      subtotalEl.textContent = `₹${orderData.subtotal.toFixed(2)}`;
      totalEl.textContent = `₹${orderData.total.toFixed(2)}`;
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }

    // Show success message
    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }

    // Hide messages
    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }

    // Handle payment method selection
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.payment-method').forEach(method => {
          method.classList.remove('active');
        });
        this.closest('.payment-method').classList.add('active');
      });
    });

    // Process payment
    async function processPayment() {
      if (!orderData) {
        showError('No order data found. Please go back to checkout.');
        return;
      }

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      const payButton = document.getElementById('payButton');
      
      payButton.disabled = true;
      payButton.textContent = 'Processing...';
      hideMessages();

      if (paymentMethod === 'cod') {
        // Cash on Delivery
        try {
          // Create order in localStorage
      const order = {
            id: orderId,
            items: orderData.items,
            total: orderData.total,
            paymentMethod: 'COD',
            status: 'pending',
            date: new Date().toISOString(),
            address: orderData.address
          };
          
          // Save to orders
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
          orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      // Clear cart
      localStorage.removeItem('cart');
          localStorage.removeItem('pendingOrder');

          showSuccess('Order placed successfully! You will pay on delivery.');

      setTimeout(() => {
        window.location.href = 'orders.html';
          }, 2000);
        } catch (error) {
          console.error('COD error:', error);
          showError('Failed to place order. Please try again.');
          payButton.disabled = false;
          payButton.textContent = 'Pay Now';
        }
      } else {
        // Razorpay payment
        try {
          const amount = orderData.total;
          
          // Create Razorpay order
          const createOrderApi = `${API_BASE}/payment/create-razorpay-order`;
          console.log('Creating Razorpay order:', { orderId, amount, url: createOrderApi });

          const orderResponse = await fetch(createOrderApi, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              orderId: Number(orderId),
              amount: Number(amount)
            })
          });

          if (!orderResponse.ok) {
            const errorText = await orderResponse.text();
            throw new Error(`Failed to create order: ${orderResponse.status} - ${errorText}`);
          }

          const orderDataResponse = await orderResponse.json();
          console.log('Backend Order Response:', orderDataResponse);

          if (!orderDataResponse.razorpayOrderId) {
            throw new Error('Backend did not return razorpayOrderId');
          }

          // Open Razorpay checkout
          const options = {
            key: orderDataResponse.razorpayKey,
            amount: orderDataResponse.amount * 100,
            currency: 'INR',
            name: 'V Store',
            description: 'Order Payment',
            order_id: orderDataResponse.razorpayOrderId,
            handler: async function(response) {
              console.log('Payment Success:', response);

              try {
                // Send callback to backend
                const callbackResponse = await fetch(`${API_BASE}/payment/razorpay-callback`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    orderId: Number(orderId),
                    amount: Number(amount)
                  })
                });

                if (!callbackResponse.ok) {
                  const errorText = await callbackResponse.text();
                  throw new Error(`Callback failed: ${callbackResponse.status} - ${errorText}`);
                }

                const callbackData = await callbackResponse.json();
                console.log('Callback Saved:', callbackData);

                // Create order in localStorage
                const order = {
                  id: orderId,
                  items: orderData.items,
                  total: orderData.total,
                  paymentMethod: 'Razorpay',
                  paymentId: response.razorpay_payment_id,
                  status: 'paid',
                  date: new Date().toISOString(),
                  address: orderData.address
                };

                // Save to orders
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));

                // Clear cart
                localStorage.removeItem('cart');
                localStorage.removeItem('pendingOrder');

                showSuccess('Payment completed successfully!');
                
                setTimeout(() => {
                  window.location.href = 'orders.html';
                }, 2000);
              } catch (error) {
                console.error('Callback error:', error);
                showError('Payment succeeded but order creation failed: ' + error.message);
                payButton.disabled = false;
                payButton.textContent = 'Pay Now';
              }
            },
            modal: {
              ondismiss: function() {
                console.log('Payment modal closed');
                payButton.disabled = false;
                payButton.textContent = 'Pay Now';
              }
            },
            theme: {
              color: '#ff6d2e'
            }
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } catch (error) {
          console.error('Payment error:', error);
          showError(error.message || 'Failed to initiate payment. Please check console for details.');
          payButton.disabled = false;
          payButton.textContent = 'Pay Now';
        }
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadOrderData();
    });
  </script>
</body>
</html>
