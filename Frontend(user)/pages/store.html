<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Store - Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../css/styles.css" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding:16px; }
    .store-header { text-align:center; margin-bottom:18px; }
    .products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; }
    .debug { margin-top:18px; border-top:1px solid #eee; padding-top:12px; }
    pre { background:#111; color:#e6e6e6; padding:12px; border-radius:6px; overflow:auto; max-height:320px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls input { padding:6px 8px; }
    .controls button { padding:6px 10px; }
  </style>
</head>
<body class="store-page">
  <!-- Set your backend base here. Change if your backend host/port is different -->
  <script>window.API_BASE = 'http://localhost:8080';</script>

  <main id="store-page">
    <header class="store-header">
      <img id="store-logo" src="../assets/logo-placeholder.png" alt="logo" style="width:80px; height:80px; border-radius:50%; object-fit:cover; display:block; margin:0 auto 12px;" />
      <h1 id="store-name">Store</h1>
      <a id="store-link" href="#" target="_blank" style="display:none; color:#0077cc;"></a>
      <p id="store-description"></p>
    </header>

    <section id="store-products">
      <h2 style="padding-left:16px;">Products</h2>
      <div id="store-products-grid" class="products-grid" style="padding:16px;"></div>
    </section>
  </main>

  <section class="debug">
    <h3>Debug API</h3>
    <div class="controls">
      <label>sellerId <input id="dbgSellerId" value="123" /></label>
      <label>storeId <input id="dbgStoreId" value="" /></label>
      <label>slug <input id="dbgSlug" value="" /></label>
      <button id="dbgLoadStore">Load Store (uses loadStorePage)</button>
      <button id="dbgFetchStore">Fetch Store (raw)</button>
      <button id="dbgFetchProducts">Fetch Products (raw)</button>
      <button id="dbgClear">Clear Output</button>
    </div>

    <h4>Last responses</h4>
    <div id="debugOutput">
      <pre id="dbgOut">(no output yet)</pre>
    </div>
  </section>

  <!-- API Integration - Must load before app.js -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/app.js"></script>
  <script>
    // Debug helpers
    function addDebug(msg) {
      const out = document.getElementById('dbgOut');
      out.textContent = (new Date()).toLocaleTimeString() + ' â€” ' + msg + '\n\n' + out.textContent;
    }

    function pretty(obj) {
      try { return JSON.stringify(obj, null, 2); } catch (e) { return String(obj); }
    }

    document.getElementById('dbgLoadStore').addEventListener('click', () => {
      // call loadStorePage from app.js which will render into the page
      try {
        if (typeof window.loadStorePage === 'function') {
          // set URL params temporarily then call
          const sellerId = document.getElementById('dbgSellerId').value || '';
          const storeId = document.getElementById('dbgStoreId').value || '';
          const slug = document.getElementById('dbgSlug').value || '';
          const params = new URLSearchParams(window.location.search);
          if (sellerId) params.set('sellerId', sellerId); else params.delete('sellerId');
          if (storeId) params.set('storeId', storeId); else params.delete('storeId');
          if (slug) params.set('slug', slug); else params.delete('slug');
          const newUrl = window.location.pathname + '?' + params.toString();
          history.replaceState({}, '', newUrl);
          window.loadStorePage();
          addDebug('Called loadStorePage() with ' + params.toString());
        } else {
          addDebug('loadStorePage() not found in app.js');
        }
      } catch (e) { addDebug('Error: ' + e.message); }
    });

    document.getElementById('dbgFetchStore').addEventListener('click', async () => {
      const sellerId = document.getElementById('dbgSellerId').value || '';
      const storeId = document.getElementById('dbgStoreId').value || '';
      const slug = document.getElementById('dbgSlug').value || '';
      let url = '';
      if (storeId) url = `${window.API_BASE.replace(/\/$/, '')}/api/stores/${encodeURIComponent(storeId)}`;
      else if (slug) url = `${window.API_BASE.replace(/\/$/, '')}/api/stores/slug/${encodeURIComponent(slug)}`;
      else if (sellerId) url = `${window.API_BASE.replace(/\/$/, '')}/api/stores/seller?sellerId=${encodeURIComponent(sellerId)}`;
      if (!url) { addDebug('No parameter provided (sellerId/storeId/slug)'); return; }
      addDebug('Fetching ' + url);
      try {
        const res = await fetch(url);
        const text = await res.text();
        addDebug('Status ' + res.status + '\n' + text);
      } catch (e) {
        addDebug('Error: ' + e.message);
      }
    });

    document.getElementById('dbgFetchProducts').addEventListener('click', async () => {
      const sellerId = document.getElementById('dbgSellerId').value || '';
      if (!sellerId) { addDebug('Provide sellerId to fetch products'); return; }
      // Try the direct query URL you provided first, then fallback to sellerProducts
      const base = window.API_BASE.replace(/\/$/, '');
      const urls = [
        `${base}/api/products?sellerId=${encodeURIComponent(sellerId)}`,
        `${base}/api/products/sellerProducts?sellerId=${encodeURIComponent(sellerId)}`
      ];
      for (const url of urls) {
        addDebug('Fetching ' + url);
        try {
          const res = await fetch(url);
          const text = await res.text();
          addDebug('Status ' + res.status + '\n' + text);
          // stop after first successful response (200)
          if (res.ok) break;
        } catch (e) {
          addDebug('Error: ' + e.message);
        }
      }
    });

    document.getElementById('dbgClear').addEventListener('click', () => {
      document.getElementById('dbgOut').textContent = '(no output yet)';
    });
  </script>
</body>
</html>